<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABIMANTRA NOT ANGKA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://tonejs.github.io/build/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --border-color: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-headings: #1a202c;
            --text-muted: #9ca3af;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --accent-focus-ring: rgba(59, 130, 246, 0.3);
            --accent-text: #ffffff;
        }

        body.dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --border-color: #4b5563;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --text-headings: #f9fafb;
            --text-muted: #6b7280;
            --accent-color: #14b8a6;
            --accent-hover: #10a392;
            --accent-focus-ring: rgba(20, 184, 166, 0.3);
            --accent-text: #111827;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            transition: all 0.3s ease-in-out;
        }

        .container {
            width: 100%;
            max-width: 1300px;
            background-color: var(--bg-secondary);
            border-radius: 1.5rem;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.05), 0 8px 25px rgba(0,0,0,0.3);
            padding: 2rem;
            transition: all 0.3s ease-in-out;
        }

        @media (min-width: 1024px) {
            .container {
                display: grid;
                grid-template-columns: 2fr;
                grid-template-rows: auto auto 2fr auto;
                grid-template-areas:
                    "title"
                    "instructions"
                    "main"
                    "footer";
                gap: 2.5rem;
            }
        }

        #app-title-wrapper { grid-area: title; }
        #main-content-area { grid-area: main; }
        #instructions-panel { grid-area: instructions; }
        .main-watermark { grid-area: footer; }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .instructions-content {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; font-size: 0.9rem; color: var(--text-primary);
        }
        .instructions-content h4 { font-weight: 600; color: var(--text-headings); margin-top: 1rem; margin-bottom: 0.5rem; }
        .instructions-content code { background-color: var(--bg-secondary); padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-weight: 600; color: var(--text-headings); }
        .instructions-content ul { list-style-position: inside; padding-left: 0.5rem; }
        .instructions-content li { margin-bottom: 0.5rem; }

        #instructions-panel.is-minimized .instructions-content { display: none; }
        #instructions-panel.is-minimized .instructions-header { margin-bottom: 0; }
        #instructions-panel.is-minimized #minimize-instructions-btn { display: none; }
        #instructions-panel #maximize-instructions-btn { display: none; }
        #instructions-panel.is-minimized #maximize-instructions-btn { display: flex; }

        .input-group { margin-bottom: 1.5rem; }
        label { color: var(--text-secondary); }
        input, select, textarea {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); transition: border-color 0.2s; color: var(--text-primary);
        }
        input::placeholder, textarea::placeholder { color: var(--text-muted); }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-focus-ring);
        }

        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; white-space: nowrap; border: 1px solid transparent; }
        .btn:disabled { cursor: not-allowed; transform: none; }
        .btn-primary { background-color: var(--accent-color); color: var(--accent-text); }
        .btn-primary:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        .btn-primary:disabled { background-color: var(--accent-color); opacity: 0.5; color: var(--accent-text); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); transform: translateY(-2px); }
        .btn-secondary:disabled { background-color: var(--bg-tertiary); color: var(--text-muted); border-color: var(--border-color); opacity: 0.7; }

        .not-container {
            border: none;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 300px;
            overflow-y: auto;
            position: relative;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .page {
            --zoom-factor: 1.0;
            background: white;
            color: #1a202c;
            width: 800px;
            max-width: 100%;
            aspect-ratio: 210 / 297;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* CORRECTED FONT STYLE RULES */
        #combined-sheet-container.font-bold .page { font-weight: normal; }
        #combined-sheet-container.font-italic .page { font-style: normal; }

        #combined-sheet-container.font-bold .note-display,
        #combined-sheet-container.font-bold .chord-note-display,
        #combined-sheet-container.font-bold .layer-text-notes {
            font-weight: 700;
        }
        #combined-sheet-container.font-italic .note-display,
        #combined-sheet-container.font-italic .chord-note-display,
        #combined-sheet-container.font-italic .layer-text-notes {
            font-style: italic;
        }


        .page .song-title { text-align: center; font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem; }
        .page .header-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; font-size: 0.9rem; color: #4a5568; }
        .page .header-info p { margin: 0 0 0.25rem 0; }
        body.fullscreen-mode .page .header-info #tempo-display { cursor: pointer; } /* Make tempo clickable only in fullscreen */

        .layer-editor-row {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: flex-start;
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            background-color: var(--bg-tertiary);
            transition: padding 0.3s ease, min-height 0.3s ease;
        }

        .layer-editor-row.is-collapsed {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.5rem 1.5rem;
            min-height: auto;
            cursor: pointer;
        }

        .layer-editor-row.is-collapsed .editor-and-controls {
            display: none;
        }

        .layer-editor-row.is-collapsed .layer-editor-header {
            margin-bottom: 0;
            border-bottom: none;
        }

        .layer-editor-row .layer-editor-header {
            width: 100%;
            padding: 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .layer-editor-row .layer-header h3 {
            font-weight: 600;
            transition: color 0.2s;
        }

        .layer-editor-row.is-collapsed:hover .layer-header h3 {
            color: var(--accent-color);
        }

        .layer-editor-row.is-collapsed .instrument-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            color: var(--text-secondary);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            transition: border-color 0.2s;
            color: var(--text-primary);
        }
        
        input::placeholder,
        textarea::placeholder {
            color: var(--text-muted);
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-focus-ring);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
            border: 1px solid transparent;
        }
        
        .btn:disabled {
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--accent-text);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background-color: var(--accent-color);
            opacity: 0.5;
            color: var(--accent-text);
        }
        
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        
        .btn-secondary:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-muted);
            border-color: var(--border-color);
            opacity: 0.7;
        }
        
        .not-container {
            border: none;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 300px;
            overflow-y: auto;
            position: relative;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .page {
            --zoom-factor: 1.0;
            background: white;
            color: #1a202c;
            width: 800px;
            max-width: 100%;
            aspect-ratio: 210 / 297;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .page .song-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .page .header-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .page .header-info p {
            margin: 0 0 0.25rem 0;
        }
        
        .layer-editor-row {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: flex-start;
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            background-color: var(--bg-tertiary);
            transition: padding 0.3s ease, min-height 0.3s ease;
        }
        
        .layer-editor-row.is-collapsed {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.5rem 1.5rem;
            min-height: auto;
            cursor: pointer;
        }
        
        .layer-editor-row.is-collapsed .editor-and-controls {
            display: none;
        }
        
        .layer-editor-row.is-collapsed .layer-editor-header {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .layer-editor-row .layer-editor-header {
            width: 100%;
            padding: 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .layer-editor-row .layer-header h3 {
            font-weight: 600;
            transition: color 0.2s;
        }
        
        .layer-editor-row.is-collapsed:hover .layer-header h3 {
            color: var(--accent-color);
        }
        
        .layer-editor-row.is-collapsed .instrument-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .editor-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            border-radius: 0.5rem;
            min-height: 120px;
            width: 100%;
        }
        
        .editor-wrapper:focus-within {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-focus-ring);
        }
        
        .layer-notation-bar-numbers,
        .layer-notation-editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0.75rem 0.75rem 0.75rem 1.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            line-height: 2.5;
            border: none;
            resize: none;
        }
        
        .layer-notation-bar-numbers {
            z-index: 1;
            pointer-events: none;
            color: transparent;
            position: relative;
        }
        
        .layer-notation-bar-numbers::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 2rem;
            transform: translateY(-50%);
            height: 1.6em;
            width: 1.5px;
            background-color: var(--text-muted);
            border-radius: 1px;
        }
        
        .chord-notation-editor {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--bg-tertiary);
            margin-bottom: 0.5rem;
            resize: none;
            font-family: 'Poppins', sans-serif;
        }
        
        .layer-notation-editor {
            z-index: 2;
            background: transparent;
            color: var(--text-primary);
            caret-color: var(--accent-color);
            outline: none;
        }
        
        .text-notation-editor {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            transition: border-color 0.2s;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
        }
        
        .text-notation-editor:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-focus-ring);
        }
        
        .editor-wrapper.text-editor-wrapper {
            position: relative;
            border: none;
            background-color: transparent;
            min-height: 120px;
        }
        
        .editor-auto-bar-line {
            position: relative;
        }
        
        .editor-auto-bar-line::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 1.5px;
            height: 1.6em;
            background-color: var(--text-muted);
            border-radius: 1px;
        }
        
        .editor-bar-number {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(0.5ch);
            padding-bottom: 0.2em;
            font-size: 0.6rem;
            color: var(--accent-color);
            font-weight: 600;
            font-style: italic;
            opacity: 0.7;
            user-select: none;
        }
        
        .music-bar {
            display: inline-flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            padding: 0 calc(0.25em * var(--zoom-factor));
            border-left: calc(2px * var(--zoom-factor)) solid #64748b;
            height: fit-content;
            gap: calc(0.5rem * var(--zoom-factor));
        }
        
        .layer-bar-notes {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: relative;
            padding: 0.25rem 0;
            width: 100%;
            min-height: 2em;
        }
        
        .layer-text-notes {
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: calc(0.9rem * var(--zoom-factor));
            color: #1a202c;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .layer-text-notes p {
            margin: 0;
            line-height: 1.5;
        }
        
        .note-block {
            display: flex;
            flex-direction: column;
            margin: 0.002cm;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 0 calc(0.2rem * var(--zoom-factor));
            min-width: 0;
            z-index: 40;
        }
        
        .note-display {
            font-size: calc(1.2rem * var(--zoom-factor));
            font-weight: 500;
            line-height: 1;
            font-family: 'Inter', sans-serif;
            z-index: 40;
        }
        
        .accidental-symbol,
        .dot-high,
        .dot-low,
        .double-dot-high,
        .double-dot-low,
        .staccato-marker {
            color: #333;
            position: absolute;
            line-height: 1;
            font-weight: 500;
        }
        
        .accidental-symbol {
            font-size: calc(1.2rem * var(--zoom-factor) * 1.2);
            z-index: 41;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .accidental-symbol.flat-symbol {
            font-weight: 300;
        }
        
        .staccato-marker {
            top: -1.0em;
            font-size: calc(1.2rem * var(--zoom-factor) * 0.8);
            font-weight: 200;
            z-index: 40;
        }
        
        .double-dot-high {
            top: -0.75em;
            font-size: calc(1.2rem * var(--zoom-factor) * 1.2);
            z-index: 45;
        }
        
        .dot-high {
            top: -0.5em;
            font-size: calc(1.2rem * var(--zoom-factor) * 0.7);
            z-index: 45;
        }
        
        .dot-low {
            bottom: -0.5em;
            font-size: calc(1.2rem * var(--zoom-factor) * 0.7);
            z-index: 35;
        }
        
        .double-dot-low {
            bottom: -0.25em;
            font-size: calc(1.2rem * var(--zoom-factor) * 1.2);
            z-index: 45;
        }
        
        .long-note-dot {
            position: absolute;
            font-size: calc(1.2rem * var(--zoom-factor));
            font-weight: 500;
            z-index: 40;
        }
        
        .note-group-container {
            display: flex;
            flex-direction: row;
            position: relative;
            align-items: center;
            min-width: 0;
        }
        
        .note-group-container.eighth-notes::before,
        .note-group-container.sixteenth-notes::before,
        .note-group-container.sixteenth-notes::after {
            background-color: #333;
            z-index: 48;
        }
        
        .note-group-container.eighth-notes::before {
            content: '';
            position: absolute;
            top: -0.6em;
            left: 10%;
            right: 10%;
            width: 80%;
            height: calc(1.5px * var(--zoom-factor));
        }
        
        .note-group-container.sixteenth-notes {
            display: flex;
            flex-direction: row;
            position: relative;
            align-items: center;
            width: 1.13cm;
        }
        
        .note-group-container.sixteenth-notes::before {
            content: '';
            position: absolute;
            top: -0.8em;
            left: 0;
            right: 0;
            width: 100%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
            padding: 0 1em;
        }
        
        .note-group-container.sixteenth-notes::after {
            content: '';
            position: absolute;
            top: -0.6em;
            left: 0;
            right: 0;
            width: 100%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
            padding: 0 1em;
        }
        
        .note-group-container.triplet::before {
            content: '';
            position: absolute;
            top: -0.7em;
            left: 0;
            right: 0;
            width: 100%;
            height: 0.5em;
            border-top: calc(1px * var(--zoom-factor)) solid #333;
            border-radius: 1em 1em 0 0;
            z-index: 38;
        }
        
        .note-group-container.triplet::after {
            content: '3';
            position: absolute;
            top: -0.7em;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.5em;
            font-weight: 400;
            color: #333;
            background-color: #fff;
            padding: 0 0.2em;
            z-index: 39;
        }
        
        .note-group-container.eighth-notes.no-staccato::before {
            top: -0.3em;
        }
        
        .note-group-container.sixteenth-notes.no-staccato::before {
            top: -0.5em;
        }
        
        .note-group-container.sixteenth-notes.no-staccato::after {
            top: -0.3em;
        }
        
        .note-group-container.triplet.no-staccato::before {
            top: -0.4em;
        }
        
        .note-group-container.triplet.no-staccato::after {
            top: -0.4em;
        }
        
        .note-group-container.combined-note-group.no-staccato::before {
            top: -0.4em;
        }
        
        .note-group-container.combined-note-group.no-staccato::after {
            top: -0.4em;
        }
        
        .combined-note-group {
            display: flex;
            flex-direction: row;
            position: relative;
            align-items: center;
            min-width: 0;
        }
        
        .combined-note-group .note-block:first-child::before,
        .combined-note-group .note-group-container::before {
            content: '';
            position: absolute;
            top: -0.6em;
            left: 30%;
            right: 0;
            width: 101%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
        }
        
        .combined-note-group .note-group-container::before {
            content: '';
            position: absolute;
            top: -0.6em;
            left: 0;
            right: 0;
            width: 40%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
        }
        
        .combined-note-group .note-group-container::after {
            content: '';
            position: absolute;
            top: -0.4em;
            left: 0;
            right: 0;
            width: 40%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
        }
        
        .note-group-container.sixteenth-eighth-group::before {
            content: '';
            position: absolute;
            top: -0.6em;
            left: 10%;
            right: 10%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
        }
        
        .note-group-container.sixteenth-eighth-group::after {
            content: '';
            position: absolute;
            top: -0.4em;
            left: 10%;
            width: 50%;
            height: calc(1.5px * var(--zoom-factor));
            background-color: #333;
            z-index: 48;
        }
        
        .notation-directives-container {
            position: absolute;
            top: -2.0em;
            left: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.2em;
            z-index: 60;
        }

        .notation-directive {
            background-color: #ffffff;
            color: #1a202c;
            font-weight: 700;
            padding: 0.1em 0.4em;
            border-radius: 0.25em;
            font-size: 0.85em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .message-box {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        
        .message-box.show {
            opacity: 1;
            top: 90px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        
        .modal.is-visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }
        
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-headings);
        }
        
        .modal-content p {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .bar-number {
            position: absolute;
            top: -1.2em;
            left: 0.25em;
            font-size: 0.6rem; 
            color: #3b82f6;
            font-weight: 600;
            font-style: italic;
            opacity: 0.7;
            user-select: none;
        }
        
        .remove-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            border: none;
        }
        
        .remove-btn:hover {
            background-color: #dc2626;
        }
        
        .bass-note {
            color: #0354f4;
            font-size: calc(0.9rem * var(--zoom-factor));
        }
        
        .chord-note-display {
            color: #ec4899;
            font-weight: 600;
            font-size: calc(0.9rem * var(--zoom-factor));
            font-family: 'Poppins', sans-serif;
        }
        
        .music-row-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin-bottom: 2.5rem;
        }
        
        .music-row {
            display: flex;
            transform-origin: top left;
            width: 100%;
        }
        
        .music-row > .music-bar {
            flex-shrink: 0;
            flex-grow: 0;
        }
        
        .row-layout-controls {
            position: absolute;
            right: -4rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        
        .music-row-wrapper:hover .row-layout-controls {
            opacity: 1;
            pointer-events: auto;
        }
        
        .row-layout-btn {
            border: none;
            background: #eaf0f6;
            color: #64748b;
            width: 1.2rem;
            height: 1.2rem;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background-color 0.2s;
        }
        
        .row-layout-btn:hover {
            background: #dde5ed;
        }
        
        .page-watermark {
            position: absolute;
            bottom: 1.5rem;
            right: 2rem;
            font-size: 0.7rem;
            font-weight: 500;
            color: #a0aec0;
            opacity: 0.9;
            pointer-events: none;
            z-index: 100;
        }
        
        .page-watermark.pdf-export-hidden {
            color: white !important;
        }
        
        .main-watermark {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        #theme-switcher .theme-btn {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        #theme-switcher .theme-btn.active {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border-color: var(--accent-color);
        }
        
        .view-mode-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            transition: all 0.2s;
        }
        
        .view-mode-btn.active {
            background-color: var(--bg-secondary);
            color: var(--accent-color);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }

        /* NEW FONT STYLE BUTTONS */
        .font-style-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            width: 2.25rem;
            height: 2.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .font-style-btn:hover {
             background-color: var(--border-color);
        }
        .font-style-btn.active {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border-color: var(--accent-color);
        }
        
        .dark .view-mode-btn.active {
            background-color: var(--bg-tertiary);
        }
        
        #combined-sheet-container.mobile-view .page {
            width: 100%;
            max-width: 420px;
            padding: 1rem;
            aspect-ratio: auto;
            min-height: 297px;
        }
        
        #combined-sheet-container.mobile-view .page .song-title {
            font-size: 1.5rem;
        }
        
        #combined-sheet-container.mobile-view .page .header-info {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        #combined-sheet-container.mobile-view .page .header-info>div {
            text-align: center !important;
        }
        
        #combined-sheet-container.tablet-view .page {
            width: 100%;
            max-width: 680px;
            padding: 1.5rem;
        }
        
        body.fullscreen-mode {
            padding: 0;
            overflow: hidden;
        }
        
        body.fullscreen-mode .container {
            max-width: 100%;
            height: 100vh;
            padding: 0;
            border-radius: 0;
            display: block;
        }
        
        body.fullscreen-mode #app-title-wrapper,
        body.fullscreen-mode #instructions-panel,
        body.fullscreen-mode #main-controls-wrapper,
        body.fullscreen-mode .main-watermark,
        body.fullscreen-mode #preview-wrapper>.flex:not(#preview-controls-container) { /* Hide original controls but not new one */
            display: none;
        }
        
        body.fullscreen-mode #main-content-area,
        body.fullscreen-mode #preview-wrapper {
            height: 100%;
            margin: 0;
        }
        
        body.fullscreen-mode #combined-sheet-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            padding-top: 5rem;
            padding-bottom: 2rem;
        }
        
        body.fullscreen-mode #fullscreen-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
        }
        
        body.fullscreen-mode #fullscreen-controls {
            display: flex;
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            gap: 0.75rem; /* Reduced gap for more buttons */
            align-items: center;
        }
        
        body:not(.fullscreen-mode) #fullscreen-controls {
            display: none;
        }
        
        #fullscreen-controls button, #fullscreen-controls select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, background-color 0.2s;
        }
        #fullscreen-controls select {
            border-radius: 0.5rem; /* Rectangular select */
            padding-right: 2rem;
        }
        #fullscreen-controls button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            padding: 0;
        }
        
        #fullscreen-controls button:hover, #fullscreen-controls select:hover {
            transform: scale(1.05);
            background: var(--bg-tertiary);
        }

        #fullscreen-controls .font-style-btn.active {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border-color: var(--accent-color);
        }
        
        #fullscreen-controls #fullscreen-play-pause-btn .play-icon,
        #fullscreen-controls #fullscreen-play-pause-btn .pause-icon {
            display: none;
        }
        
        #fullscreen-controls #fullscreen-play-pause-btn.playing .pause-icon {
            display: block;
        }
        
        #fullscreen-controls #fullscreen-play-pause-btn:not(.playing) .play-icon {
            display: block;
        }
        
        .music-bar.repeat-start {
            border-left-style: double;
            border-left-width: calc(4px * var(--zoom-factor));
            padding-left: calc(0.5em * var(--zoom-factor));
        }
        
        .music-bar.repeat-end {
            border-right-style: double;
            border-right-width: calc(4px * var(--zoom-factor));
            padding-right: calc(0.5em * var(--zoom-factor));
        }
        
        .music-bar.repeat-start::before,
        .music-bar.repeat-start::after {
            content: '•';
            position: absolute;
            font-size: calc(1.2em * var(--zoom-factor));
            color: #1a202c;
            line-height: 1;
            left: calc(0.1em * var(--zoom-factor));
            transform: translateY(-50%);
        }
        
        .music-bar.repeat-end::before,
        .music-bar.repeat-end::after {
            content: '•';
            position: absolute;
            font-size: calc(1.2em * var(--zoom-factor));
            color: #1a202c;
            line-height: 1;
            right: calc(0.1em * var(--zoom-factor));
            transform: translateY(-50%);
        }
        
        .music-bar.repeat-start::before,
        .music-bar.repeat-end::before {
            top: 40%;
        }
        
        .music-bar.repeat-start::after,
        .music-bar.repeat-end::after {
            top: 60%;
        }
        
        .music-bar.has-volta .bar-number {
            opacity: 0.15;
        }
        
        .volta-bracket {
            position: absolute;
            top: -1.8em;
            left: 0;
            height: 0.8em;
            border-top: calc(1.5px * var(--zoom-factor)) solid #1a202c;
            border-left: calc(1.5px * var(--zoom-factor)) solid #1a202c;
            padding-left: 0.3em;
            font-size: 0.7em;
            font-weight: 700;
            color: #1a202c;
            z-index: 50;
        }
        
        .volta-bracket.is-end {
            border-right: calc(1.5px * var(--zoom-factor)) solid #1a202c;
        }
        
        .volta-bracket-end-hook {
            position: absolute;
            top: 0;
            right: calc(-1.5px * var(--zoom-factor));
            height: calc(0.5em * var(--zoom-factor));
            width: calc(1.5px * var(--zoom-factor));
            background-color: #1a202c;
        }
        
        #floating-editor-window {
            position: fixed;
            top: 150px;
            right: 40px;
            width: 600px;
            max-width: 90vw;
            max-height: 70vh;
            background-color: var(--bg-secondary);
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
            min-width: 300px;
            min-height: 200px;
        }
        
        #floating-editor-window.is-minimized {
            opacity: 0;
            pointer-events: none;
        }
        
        .floating-editor-header {
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--text-headings);
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            cursor: move;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #editor-window-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .editor-control-btn {
            background-color: var(--border-color);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .editor-control-btn:hover {
            background-color: var(--text-muted);
        }
        
        .editor-control-btn svg {
            width: 12px;
            height: 12px;
            stroke: var(--text-primary);
            stroke-width: 2.5;
        }
        
        #maximize-editor-btn {
            display: none;
        }
        
        #floating-editor-window.is-minimized #minimize-editor-btn {
            display: none;
        }
        
        #floating-editor-window.is-minimized #maximize-editor-btn {
            display: flex;
        }
        
        .resizer {
            position: absolute;
            background: transparent;
            z-index: 1001;
        }
        
        .resizer-r {
            width: 8px;
            height: 100%;
            top: 0;
            right: 0;
            cursor: ew-resize;
        }
        
        .resizer-b {
            width: 100%;
            height: 8px;
            left: 0;
            bottom: 0;
            cursor: ns-resize;
        }
        
        .resizer-rb {
            width: 12px;
            height: 12px;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
        }
        
        .resizer-t {
            width: 100%;
            height: 8px;
            left: 0;
            top: 0;
            cursor: ns-resize;
        }
        
        .resizer-l {
            width: 8px;
            height: 100%;
            left: 0;
            top: 0;
            cursor: ew-resize;
        }
        
        .resizer-lt {
            width: 12px;
            height: 12px;
            left: 0;
            top: 0;
            cursor: nwse-resize;
        }
        
        .resizer-rt {
            width: 12px;
            height: 12px;
            right: 0;
            top: 0;
            cursor: nesw-resize;
        }
        
        .resizer-bl {
            width: 12px;
            height: 12px;
            left: 0;
            bottom: 0;
            cursor: nesw-resize;
        }
        
        #layers-editor-container {
            overflow-y: auto;
            padding: 1.5rem;
            flex-grow: 1;
        }
        
        .layer-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            cursor: pointer;
            width: 100%;
            padding: 0.5rem 0;
        }
        
        .layer-editor-header.is-expanded {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .editor-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .layer-editor-row.is-collapsed .editor-wrapper,
        .layer-editor-row.is-collapsed .remove-btn,
        .layer-editor-row.is-collapsed .layer-controls {
            display: none;
        }
        
        .layer-editor-row.is-collapsed .layer-editor-header {
            padding: 0.5rem 1.5rem;
        }
        
        .layer-editor-row:not(.is-collapsed) .layer-editor-header {
            display: none;
        }
        
        .layer-editor-row:not(.is-collapsed) .editor-and-controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: flex-start;
            width: 100%;
        }
        
        #show-editor-button {
            position: fixed;
            top: 6rem;
            right: 2rem;
            z-index: 999;
            display: none;
            background-color: var(--bg-tertiary);
            color: rgb(255, 255, 255);
            padding: 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgb(255, 254, 254), 0 2px 4px -1px rgb(255, 253, 253);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, background-color 0.2s;
        }
        
        #show-editor-button:hover {
            transform: scale(1.05);
            background-color: rgb(32, 46, 88);
        }
        
        #show-editor-button.is-visible {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="message-box" class="message-box"></div>
    
    <div id="new-project-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--text-headings);">Mulai Proyek Baru?</h3>
            <p style="color: var(--text-primary);">Tindakan ini akan menghapus semua data notasi yang sedang Anda kerjakan. Apakah Anda yakin ingin melanjutkan?</p>
            <div class="modal-buttons">
                <button id="confirm-new-project-btn" class="btn btn-primary">Ya, Mulai Baru</button>
                <button id="cancel-new-project-btn" class="btn btn-secondary">Batal</button>
            </div>
        </div>
    </div>

    <div id="tempo-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--text-headings);">Ubah Tempo</h3>
            <div class="input-group">
                <input type="number" id="modal-tempo-input" class="w-full text-center text-lg" value="120" min="40" max="240">
            </div>
            <div class="modal-buttons">
                <button id="confirm-tempo-btn" class="btn btn-primary">Atur</button>
                <button id="cancel-tempo-btn" class="btn btn-secondary">Batal</button>
            </div>
        </div>
    </div>
    
    <div class="container" id="main-container">
        <div id="app-title-wrapper" class="flex justify-between items-center">
            <div id="theme-switcher" class="flex gap-2">
                <button id="light-theme-btn" class="theme-btn" title="Light Mode">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
                <button id="dark-theme-btn" class="theme-btn" title="Dark Mode">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
            <h1 class="text-3xl font-bold text-center flex-grow text-gray-50" style="color: var(--text-headings);">ABIMANTRA NOT ANGKA</h1>
        </div>

        <div id="instructions-panel" class="is-minimized">
            <div class="instructions-header">
                <h2 class="text-lg font-bold text-gray-200" style="color: var(--text-headings);">Petunjuk</h2>
                <div id="instructions-window-controls">
                    <button id="minimize-instructions-btn" class="editor-control-btn" title="Minimize">
                        <svg viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 6H11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                    <button id="maximize-instructions-btn" class="editor-control-btn" title="Maximize">
                        <svg viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 8.5V3.5C1.5 2.39543 2.39543 1.5 3.5 1.5H8.5C9.60457 1.5 10.5 2.39543 10.5 3.5V8.5C10.5 9.60457 9.60457 10.5 8.5 10.5H3.5C2.39543 10.5 1.5 9.60457 1.5 8.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                </div>
            </div>
            <div class="instructions-content space-y-3">
                <div><h4>Dasar</h4><ul><li><code>1-7</code> untuk not.</li><li><code>0</code> untuk istirahat (diam), <code>o</code> untuk istirahat panjang (titik).</li><li>Spasi atau <code>|</code> untuk pemisah ketukan/bar.</li></ul></div>
                <div><h4>Oktaf & Aksidental</h4><ul><li><code>1.</code> (tinggi), <code>1,</code> (rendah). Ganda juga bisa.</li><li><code>4/</code> (kres), <code>7b</code> (mol). Nada ini akan menimpa Tonalitas.</li></ul></div>
                <div><h4>Durasi & Artikulasi</h4><ul><li><code>12</code> (1/8), <code>1234</code> (1/16), <code>123</code> (triplet).</li><li><code>1-23</code> untuk not 1/8 + dua not 1/16.</li><li><code>123-</code> untuk dua not 1/16 + satu not 1/8.</li><li><code>1^</code> (staccato).</li><li><code>1~</code> (fermata/tahan).</li></ul></div>
                <div><h4 class="text-teal-500">Fitur Baru: Perubahan di Tengah Lagu</h4><ul><li>Ubah Birama: Tulis <code>(B=3/4)</code> untuk mengubah birama menjadi 3/4.</li><li>Ubah Tonalitas: Tulis <code>(Do=G)</code> untuk mengubah nada dasar menjadi Do = G.</li><li>Perubahan ini berlaku untuk semua not setelahnya.</li><li>Contoh: <code>1 2 3 4 | (B=3/4) 5 6 7 | (Do=G) 1 2 3 |</code></li></ul></div>
                <div><h4>Pengulangan (Layer 1)</h4><ul><li><code>[</code> untuk mulai ulang, <code>]</code> untuk akhir ulang.</li><li><code>_a, _b, _c, _d</code> untuk ending 1-4.</li><li>Contoh: <code>[ 1 2 | _a 3 4 ] | _b 5 0 |</code></li></ul></div>
                <div><h4>Layer Accomp</h4><ul><li>Pilih instrumen "Accomp". Layer ini akan selalu di atas pada pratinjau.</li><li>Tulis nama chord (misal: <code>C G Am F</code>).</li><li>Gunakan <code>z</code> untuk istirahat 1 ketuk (tidak terlihat).</li></ul></div>
                <div><h4>Fitur Editor</h4><ul><li>Undo/Redo: <code>Ctrl/Cmd + Z</code> & <code>Y</code>.</li><li>Gunakan tombol <code>+/-</code> di ujung tiap baris untuk mengubah jumlah bar di baris tersebut.</li></ul></div>
                <div><h4>Simpan & Buka Proyek</h4><ul><li>Gunakan tombol <b>Simpan Proyek</b> untuk mengunduh pekerjaan Anda sebagai file <code>.abimantra</code>.</li><li>Gunakan <b>Buka Proyek</b> untuk memuat file proyek yang sudah disimpan.</li></ul></div>
            </div>
        </div>

        <div id="main-content-area">
            <div id="main-controls-wrapper">
                <div class="input-group">
                    <label for="title" class="block font-semibold mb-2">Judul Lagu</label>
                    <input type="text" id="title" class="w-full text-center" placeholder="Masukkan judul lagu...">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="bpm" class="block font-semibold mb-2">Tempo</label>
                        <input type="number" id="bpm" class="w-full" value="120" min="40" max="240">
                    </div>
                    <div>
                        <label for="tonalitas" class="block font-semibold mb-2">Tonalitas (Awal)</label>
                        <select id="tonalitas" class="w-full">
                            <option value="C">Do = C</option>
                            <optgroup label="Kres (♯)">
                                <option value="G">Do = G (1♯)</option>
                                <option value="D">Do = D (2♯)</option>
                                <option value="A">Do = A (3♯)</option>
                                <option value="E">Do = E (4♯)</option>
                                <option value="B">Do = B (5♯)</option>
                            </optgroup>
                            <optgroup label="Mol (♭)">
                                <option value="F">Do = F (1♭)</option>
                                <option value="Bb">Do = B♭ (2♭)</option>
                                <option value="Eb">Do = E♭ (3♭)</option>
                                <option value="Ab">Do = A♭ (4♭)</option>
                                <option value="Db">Do = D♭ (5♭)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label for="birama" class="block font-semibold mb-2">Birama (Awal)</label>
                        <select id="birama" class="w-full">
                            <option value="4/4">4/4</option>
                            <option value="3/4">3/4</option>
                            <option value="2/4">2/4</option>
                            <option value="5/4">5/4</option>
                            <option value="6/8">6/8</option>
                            <option value="7/8">7/8</option>
                            <option value="9/8">9/8</option>
                        </select>
                    </div>
                    <div class="sm:col-span-1">
                        <label for="composer" class="block font-semibold mb-2">Komposer</label>
                        <input type="text" id="composer" class="w-full" placeholder="Nama komposer...">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="arranger" class="block font-semibold mb-2">Arranger</label>
                        <input type="text" id="arranger" class="w-full" placeholder="Nama arranger...">
                    </div>
                </div>

                <div class="flex flex-wrap justify-end items-center gap-4 mt-6">
                    <button id="newProjectBtn" class="btn btn-secondary">Proyek Baru</button>
                    <button id="saveProjectBtn" class="btn btn-secondary">Simpan Proyek</button>
                    <button id="loadProjectBtn" class="btn btn-secondary">Buka Proyek</button>
                    <input type="file" id="loadProjectInput" class="hidden" accept=".abimantra,.json">
                    <button id="playBtn" class="btn btn-primary">Mainkan</button>
                    <button id="downloadPngBtn" class="btn btn-primary">Unduh PNG</button>
                    <button id="downloadPdfBtn" class="btn btn-primary">Unduh PDF</button>
                </div>
            </div>

            <div id="preview-wrapper">
                <div id="preview-controls-container" class="flex justify-between items-center mt-8 mb-4">
                    <div id="view-mode-controls" class="flex items-center gap-2">
                        <label class="font-semibold hidden sm:block">Tampilan</label>
                        <div class="flex rounded-md bg-gray-100 dark:bg-gray-900 p-1 border border-gray-200 dark:border-gray-700">
                            <button class="view-mode-btn px-3 py-1 text-sm font-semibold rounded-md flex items-center gap-1" data-view="mobile" title="Tampilan Mobile">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                                <span class="hidden md:inline">Mobile</span>
                            </button>
                            <button class="view-mode-btn px-3 py-1 text-sm font-semibold rounded-md flex items-center gap-1" data-view="tablet" title="Tampilan Tablet">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                                <span class="hidden md:inline">Tablet</span>
                            </button>
                            <button class="view-mode-btn px-3 py-1 text-sm font-semibold rounded-md active flex items-center gap-1" data-view="pc" title="Tampilan PC">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="2" y1="21" x2="22" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                                <span class="hidden md:inline">PC</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-end gap-4">
                        <div id="font-controls-container" class="flex items-center gap-2">
                             <div class="font-style-controls flex items-center gap-1 p-1 rounded-md bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
                                <button id="font-normal-btn" class="font-style-btn" title="Normal">N</button>
                                <button id="font-bold-btn" class="font-style-btn" title="Bold (Ctrl+B)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                                </button>
                                <button id="font-italic-btn" class="font-style-btn" title="Italic (Ctrl+I)">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>
                                </button>
                            </div>
                            <select id="fontSizeSelect" class="w-auto">
                                <option value="1.0">Kecil</option>
                                <option value="1.2" selected>Normal</option>
                                <option value="1.5">Besar</option>
                                <option value="1.8">Sangat Besar</option>
                            </select>
                        </div>
                        <div id="bars-per-row-container" class="flex items-center gap-2">
                            <label for="barsPerRowSelect" class="font-semibold">Bar/Baris</label>
                            <select id="barsPerRowSelect" class="w-auto">
                                <option value="4" selected>4</option> <option value="5">5</option> <option value="6">6</option>
                                <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="combined-sheet-container" class="not-container">
                    <button id="fullscreen-btn" class="absolute top-4 right-4 z-50 p-2 rounded-full bg-white/60 backdrop-blur-sm hover:bg-white/90 dark:bg-black/40 dark:hover:bg-black/70 transition-colors duration-200" title="Layar Penuh">
                        <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                        <svg id="fullscreen-exit-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0-2-2h-3M3 16h3a2 2 0 0 0 2-2v-3"/></svg>
                    </button>
                    </div>

                <div id="layers-editor-placeholder"></div>
            </div>
        </div>

        <div class="main-watermark">Dibuat dengan ABIMANTRA NOT ANGKA | by Yoga Andika</div>
    </div>
    
    <button id="show-editor-button" title="Tampilkan Editor">
        𓂃🖊
    </button>
    
    <div id="fullscreen-controls" class="hidden">
        <button id="fullscreen-play-pause-btn" title="Mainkan/Berhenti">
            <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        </button>
        <button id="fullscreen-stop-btn" title="Stop">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12"></rect></svg>
        </button>
        <div class="font-style-controls flex items-center gap-1">
            <button id="fullscreen-font-normal-btn" class="font-style-btn" title="Normal">N</button>
            <button id="fullscreen-font-bold-btn" class="font-style-btn" title="Bold (Ctrl+B)">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
            </button>
            <button id="fullscreen-font-italic-btn" class="font-style-btn" title="Italic (Ctrl+I)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>
            </button>
        </div>
        <select id="fullscreen-font-size-select">
            <option value="1.0">Kecil</option>
            <option value="1.2" selected>Normal</option>
            <option value="1.5">Besar</option>
            <option value="1.8">Sangat Besar</option>
        </select>
        <button id="fullscreen-new-project-btn" title="Proyek Baru">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
        </button>
        <button id="fullscreen-save-project-btn" title="Simpan Proyek">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        </button>
         <button id="fullscreen-load-project-btn" title="Buka Proyek">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
        </button>
        <button id="fullscreen-download-png-btn" title="Unduh PNG">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        </button>
        <button id="fullscreen-download-pdf-btn" title="Unduh PDF">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </button>
    </div>

    <script>
        // --- UTILITY FUNCTIONS ---
        function showMessageBox(message, type = 'success') {
            const box = document.getElementById('message-box'); box.textContent = message;
            box.style.backgroundColor = type === 'success' ? '#22c55e' : '#ef4444'; box.classList.add('show');
            setTimeout(() => { box.classList.remove('show'); }, 3000);
        }

        function showModal(id) {
            document.getElementById(id).classList.add('is-visible');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('is-visible');
        }

        function playSingleNote(noteChar, layerIndex) {
            const layer = layers[layerIndex];
            if (!layer || layer.instrument === 'accomp' || layer.instrument === 'text') return;

            const currentKey = tonalitasSelect.value;
            
            const noteData = { visualNote: noteChar, visualModifier: '', isStaccato: false, isFermata: false };
            const toneNote = getToneNote(noteData, layer, currentKey);

            if (toneNote) {
                const player = TonePlayers[layer.instrument];
                player.triggerAttackRelease(toneNote, '8n');
                }
        }

        // --- GLOBAL VARIABLES & DOM ELEMENTS ---
        let playBtn, addLayerBtn, downloadPngBtn, downloadPdfBtn, titleInput, arrangerInput, composerInput, biramaSelect, tonalitasSelect, bpmInput, combinedSheetContainer, layersEditorContainer, barsPerRowSelect, undoBtn, redoBtn, fullscreenBtn, saveProjectBtn, loadProjectBtn, loadProjectInput, fontSizeSelect;
        let fullscreenPlayPauseBtn, fullscreenStopBtn;
        let newProjectBtn, newProjectModal, confirmNewProjectBtn, cancelNewProjectBtn, tempoModal, confirmTempoBtn, cancelTempoBtn, modalTempoInput;
        let fontNormalBtn, fontBoldBtn, fontItalicBtn, fullscreenFontSizeSelect, fullscreenFontNormalBtn, fullscreenFontBoldBtn, fullscreenFontItalicBtn, fullscreenDownloadPngBtn, fullscreenDownloadPdfBtn, fullscreenSaveProjectBtn, fullscreenLoadProjectBtn, fullscreenNewProjectBtn;

        let fontStyle = { bold: false, italic: false };
        let highlightBarIntervalId = [];

        function assignGlobalDOMElements() {
            playBtn = document.getElementById('playBtn');
            downloadPngBtn = document.getElementById('downloadPngBtn');
            downloadPdfBtn = document.getElementById('downloadPdfBtn');
            fullscreenBtn = document.getElementById('fullscreen-btn');
            titleInput = document.getElementById('title');
            arrangerInput = document.getElementById('arranger');
            composerInput = document.getElementById('composer');
            biramaSelect = document.getElementById('birama');
            tonalitasSelect = document.getElementById('tonalitas');
            bpmInput = document.getElementById('bpm');
            combinedSheetContainer = document.getElementById('combined-sheet-container');
            barsPerRowSelect = document.getElementById('barsPerRowSelect');
            saveProjectBtn = document.getElementById('saveProjectBtn');
            loadProjectBtn = document.getElementById('loadProjectBtn');
            loadProjectInput = document.getElementById('loadProjectInput');
            
            newProjectBtn = document.getElementById('newProjectBtn');
            newProjectModal = document.getElementById('new-project-modal');
            confirmNewProjectBtn = document.getElementById('confirm-new-project-btn');
            cancelNewProjectBtn = document.getElementById('cancel-new-project-btn');

            tempoModal = document.getElementById('tempo-modal');
            confirmTempoBtn = document.getElementById('confirm-tempo-btn');
            cancelTempoBtn = document.getElementById('cancel-tempo-btn');
            modalTempoInput = document.getElementById('modal-tempo-input');
            
            undoBtn = document.getElementById('undoBtn');
            redoBtn = document.getElementById('redoBtn');
            addLayerBtn = document.getElementById('addLayerBtn');
            layersEditorContainer = document.getElementById('layers-editor-container');
            
            // New Font & Fullscreen controls
            fontSizeSelect = document.getElementById('fontSizeSelect');
            fontNormalBtn = document.getElementById('font-normal-btn');
            fontBoldBtn = document.getElementById('font-bold-btn');
            fontItalicBtn = document.getElementById('font-italic-btn');
            
            fullscreenPlayPauseBtn = document.getElementById('fullscreen-play-pause-btn');
            fullscreenStopBtn = document.getElementById('fullscreen-stop-btn');
            fullscreenFontSizeSelect = document.getElementById('fullscreen-font-size-select');
            fullscreenFontNormalBtn = document.getElementById('fullscreen-font-normal-btn');
            fullscreenFontBoldBtn = document.getElementById('fullscreen-font-bold-btn');
            fullscreenFontItalicBtn = document.getElementById('fullscreen-font-italic-btn');
            fullscreenDownloadPngBtn = document.getElementById('fullscreen-download-png-btn');
            fullscreenDownloadPdfBtn = document.getElementById('fullscreen-download-pdf-btn');
            fullscreenSaveProjectBtn = document.getElementById('fullscreen-save-project-btn');
            fullscreenLoadProjectBtn = document.getElementById('fullscreen-load-project-btn');
            fullscreenNewProjectBtn = document.getElementById('fullscreen-new-project-btn');
        }
        
        let zoomFactor = 1.0; let layers = []; let TonePlayers = {};
        let activeLayerIndex = 0;
        
        const baseNoteMap = { '1': 'C', '2': 'D', '3': 'E', '4': 'F', '5': 'G', '6': 'A', '7': 'B', '0': null, 'o': null };
        const bassDisplayMap = { '1': 'C', '2': 'D', '3': 'E', '4': 'F', '5': 'G', '6': 'A', '7': 'B' };
        
        // --- AUDIO INITIALIZATION ---
        function initializeInstruments() {
            TonePlayers = {
                'flute': new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.1, release: 1 } }).toDestination(),
                'piano': new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                'bass': new Tone.FMSynth({ carrier: { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.8 }, }, modulator: { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }, }, harmonicity: 0.5, modulationIndex: 1, }).toDestination(),
                'accomp': new Tone.FMSynth({ carrier: { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.8 }, }, modulator: { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }, }, harmonicity: 0.5, modulationIndex: 1, }).toDestination()
            };
        }
        
        // --- HISTORY MANAGEMENT ---
        function recordHistory(layerIndex, notation) {
            const layer = layers[layerIndex];
            if (layer.history[layer.historyIndex] === notation) return;

            layer.history = layer.history.slice(0, layer.historyIndex + 1);
            layer.history.push(notation);
            layer.historyIndex++;
            updateUndoRedoButtons();
        }

        function undo() {
            if (activeLayerIndex === null) return;
            const layer = layers[activeLayerIndex];
            if (layer.historyIndex > 0) {
                layer.historyIndex--;
                layer.notation = layer.history[layer.historyIndex];
                renderAll();
            }
        }

        function redo() {
            if (activeLayerIndex === null) return;
            const layer = layers[activeLayerIndex];
            if (layer.historyIndex < layer.history.length - 1) {
                layer.historyIndex++;
                layer.notation = layer.history[layer.historyIndex];
                renderAll();
            }
        }

        function updateUndoRedoButtons() {
            if (activeLayerIndex === null || !layers[activeLayerIndex]) {
                undoBtn.disabled = true;
                redoBtn.disabled = true;
                return;
            }
            const layer = layers[activeLayerIndex];
            undoBtn.disabled = layer.historyIndex <= 0;
            redoBtn.disabled = layer.historyIndex >= layer.history.length - 1;
        }

        // --- FONT STYLE MANAGEMENT ---
        function updateFontStyleButtons() {
            fontBoldBtn.classList.toggle('active', fontStyle.bold);
            fullscreenFontBoldBtn.classList.toggle('active', fontStyle.bold);
            fontItalicBtn.classList.toggle('active', fontStyle.italic);
            fullscreenFontItalicBtn.classList.toggle('active', fontStyle.italic);

            const isNormal = !fontStyle.bold && !fontStyle.italic;
            fontNormalBtn.classList.toggle('active', isNormal);
            fullscreenFontNormalBtn.classList.toggle('active', isNormal);
        }

        function applyFontStyle() {
            combinedSheetContainer.classList.toggle('font-bold', fontStyle.bold);
            combinedSheetContainer.classList.toggle('font-italic', fontStyle.italic);
            updateFontStyleButtons();
        }

        function toggleStyle(style) { // style is 'bold' or 'italic'
            fontStyle[style] = !fontStyle[style];
            applyFontStyle();
        }
        
        function setNormalStyle() {
            fontStyle.bold = false;
            fontStyle.italic = false;
            applyFontStyle();
        }


        // --- NOTATION PROCESSING & DISPLAY ---
        function getBars(layerNotation, initialBirama, isAccompLayer = false) {
            const keyChangeRegex = /\(Do=([A-G][b#]?)\)/i;
            const timeSigChangeRegex = /\(B=(\d{1,2}\/\d{1,2})\)/i;
            const directiveRegex = /(\([Bb]=[\d\/]+\)|\(Do=[A-Ga-g][b#]?\))/g;
            const tokens = layerNotation.replace(directiveRegex, ' $1 ').replace(/\|/g, ' | ').split(/\s+/g).filter(n => n !== '');
            
            let bars = [];
            let currentBar = { notes: [], annotations: [] };
            let currentBirama = initialBirama;
            let beatsPerBar = parseInt(currentBirama.split('/')[0]);
            let currentBarBeats = 0;
            
            const pushBar = () => {
                if (currentBar.notes.length > 0 || currentBar.annotations.length > 0 || currentBar.newKey || currentBar.newTimeSignature) {
                    bars.push(currentBar);
                }
                currentBar = { notes: [], annotations: [] };
                currentBarBeats = 0;
            };
            
            if (isAccompLayer) {
                 for (const token of tokens) {
                    if (token === '|') { pushBar(); continue; }
                    const duration = 1;
                    if (currentBarBeats + duration > beatsPerBar) { pushBar(); }
                    currentBar.notes.push({ type: 'chord', text: token, duration: duration });
                    currentBarBeats += duration;
                    if (currentBarBeats >= beatsPerBar) { pushBar(); }
                }
            } else {
                const noteRegex = /([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)/g;
                const mixedNoteRegex = /^([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)-([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)$/;
                const sixteenthEighthRegex = /^([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)-$/;

                for (const token of tokens) {
                    const keyMatch = token.match(keyChangeRegex);
                    if (keyMatch) {
                        currentBar.newKey = keyMatch[1];
                        continue;
                    }

                    const timeSigMatch = token.match(timeSigChangeRegex);
                    if (timeSigMatch) {
                        currentBirama = timeSigMatch[1];
                        beatsPerBar = parseInt(currentBirama.split('/')[0]);
                        currentBar.newTimeSignature = currentBirama;
                        continue;
                    }

                    if (token === '|') { pushBar(); continue; }
                    if (['[', ']', '_a', '_b', '_c', '_d'].includes(token)) { currentBar.annotations.push(token); continue; }

                    let noteData;
                    const mixedNotesMatch = token.match(mixedNoteRegex);
                    const sixteenthEighthMatch = token.match(sixteenthEighthRegex);

                    if (sixteenthEighthMatch) {
                        const [_, n1, a1, o1, s1, f1, n2, a2, o2, s2, f2, n3, a3, o3, s3, f3] = sixteenthEighthMatch;
                        noteData = { type: 'sixteenth-eighth-group', notes: [
                            { visualNote: n1, visualSharp: a1 === '/', visualFlat: a1 === 'b', visualModifier: o1, isStaccato: s1.includes('^'), isFermata: f1.includes('~'), duration: 0.25 },
                            { visualNote: n2, visualSharp: a2 === '/', visualFlat: a2 === 'b', visualModifier: o2, isStaccato: s2.includes('^'), isFermata: f2.includes('~'), duration: 0.25 },
                            { visualNote: n3, visualSharp: a3 === '/', visualFlat: a3 === 'b', visualModifier: o3, isStaccato: s3.includes('^'), isFermata: f3.includes('~'), duration: 0.5 }
                        ], duration: 1 };
                    } else if (mixedNotesMatch) {
                         const [_, n1, a1, o1, s1, f1, n2, a2, o2, s2, f2, n3, a3, o3, s3, f3] = mixedNotesMatch;
                        noteData = { type: 'mixed-eighth-sixteenth', notes: [
                                { visualNote: n1, visualSharp: a1 === '/', visualFlat: a1 === 'b', visualModifier: o1, isStaccato: s1.includes('^'), isFermata: f1.includes('~'), duration: 0.5 },
                                { visualNote: n2, visualSharp: a2 === '/', visualFlat: a2 === 'b', visualModifier: o2, isStaccato: s2.includes('^'), isFermata: f2.includes('~'), duration: 0.25 },
                                { visualNote: n3, visualSharp: a3 === '/', visualFlat: a3 === 'b', visualModifier: o3, isStaccato: s3.includes('^'), isFermata: f3.includes('~'), duration: 0.25 }
                        ], duration: 1 };
                    } else {
                        const notesInToken = [...token.matchAll(noteRegex)];
                        if (notesInToken.length === 2) {
                            const groupData = notesInToken.map(m => { const [_, note, acc, oct, stac, fermata] = m; return { visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~'), duration: 0.5 }; });
                            noteData = { type: 'group', notes: groupData, duration: 1 };
                        } else if (notesInToken.length === 3) {
                            const groupData = notesInToken.map(m => { const [_, note, acc, oct, stac, fermata] = m; return { visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~'), duration: 1/3 }; });
                            noteData = { type: 'triplet', notes: groupData, duration: 1 };
                        } else if (notesInToken.length === 4) {
                            const groupData = notesInToken.map(m => { const [_, note, acc, oct, stac, fermata] = m; return { visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~'), duration: 0.25 }; });
                            noteData = { type: 'group', notes: groupData, duration: 1 };
                        } else if (notesInToken.length > 0) {
                            const [_, note, acc, oct, stac, fermata] = notesInToken[0];
                            noteData = { type: 'single', visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~'), duration: 1 };
                        } else {
                            continue; // Skip invalid tokens
                        }
                    }

                    if (currentBarBeats + noteData.duration > beatsPerBar) { pushBar(); }
                    currentBar.notes.push(noteData);
                    currentBarBeats += noteData.duration;
                    if (currentBarBeats >= beatsPerBar) { pushBar(); }
                }
            }
            if (currentBar.notes.length > 0 || currentBar.annotations.length > 0 || currentBar.newKey || currentBar.newTimeSignature) { pushBar(); }
            return bars;
        }

        function getTransposedBassNoteName(noteData, currentKey) {
            const scaleIntervals = { '1': 0, '2': 2, '3': 4, '4': 5, '5': 7, '6': 9, '7': 11 };
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const rootNoteIndexes = { 'C': 0, 'G': 7, 'D': 2, 'A': 9, 'E': 4, 'B': 11, 'F': 5, 'Bb': 10, 'Eb': 3, 'Ab': 8, 'Db': 1 };
            
            const rootIndex = rootNoteIndexes[currentKey];
            
            let interval = scaleIntervals[noteData.visualNote];
            if (interval === undefined) return noteData.visualNote;

            if (noteData.visualSharp) interval += 1;
            else if (noteData.visualFlat) interval -= 1;
            
            const finalNoteIndex = (rootIndex + interval + 12) % 12;
            return noteNames[finalNoteIndex];
        }

        function createNoteBlockHtml(noteData, isBass, currentKey) {
            let innerHtml = '';
            const noteClass = isBass ? 'bass-note' : '';

            if (noteData.isStaccato) {
                innerHtml += `<span class="staccato-marker">^</span>`;
            }

            if (noteData.isFermata) {
                let fermataTopOffset = -1.2; // Default closer position
                if (noteData.isStaccato) {
                    fermataTopOffset = -1.8; // Higher position if staccato is present
                }
                innerHtml += `<span style="position: absolute; font-size: 1.8em; top: ${fermataTopOffset}em; left: 50%; transform: translateX(-50%); z-index: 51; color: #1a202c; line-height: 1;">𝄐</span>`;
            }

            if (noteData.visualNote === 'o') {
                innerHtml += `<span class="long-note-dot ${noteClass}">&#x2022;</span>`;
            } else if (noteData.visualNote === '0') {
                innerHtml += `<span class="note-display ${noteClass}">0</span>`;
            } else {
                let noteToDisplay;
                if (isBass) {
                    noteToDisplay = getTransposedBassNoteName(noteData, currentKey);
                } else {
                    noteToDisplay = noteData.visualNote;
                    if (noteData.visualSharp) {
                        innerHtml += `<span class="accidental-symbol sharp-symbol">&#x2044;</span>`;
                    } else if (noteData.visualFlat) {
                        innerHtml += `<span class="accidental-symbol flat-symbol">\\</span>`;
                    }
                }
                
                innerHtml += `<span class="note-display ${noteClass}">${noteToDisplay}</span>`;

                if (noteData.visualModifier === '..') {
                    innerHtml += `<span class="double-dot-high ${noteClass}">..</span>`;
                } else if (noteData.visualModifier === '.') {
                    innerHtml += `<span class="dot-high ${noteClass}">&#x2022;</span>`;
                }
                if (noteData.visualModifier === ',,') {
                    innerHtml += `<span class="double-dot-low ${noteClass}">..</span>`;
                } else if (noteData.visualModifier === ',') {
                    innerHtml += `<span class="dot-low ${noteClass}">&#x2022;</span>`;
                }
            }

            return `<div class="note-block">${innerHtml}</div>`;
        }

        function generateBarContentHtml(barNotes, layer, currentKey) {
            let barContentHtml = '';
            const isBass = layer.instrument === 'bass';
            const isAccomp = layer.instrument === 'accomp';

            if (isAccomp) {
                barNotes.forEach(noteData => {
                    if (noteData.text.toLowerCase() !== 'z') {
                        barContentHtml += `<div class="note-block"><span class="chord-note-display">${noteData.text}</span></div>`;
                    } else {
                        barContentHtml += `<div class="note-block">&nbsp;</div>`;
                    }
                });
            } else {
                barNotes.forEach(noteData => {
                    if (noteData.type === 'sixteenth-eighth-group') {
                        const notesHtml = noteData.notes.map(n => createNoteBlockHtml(n, isBass, currentKey)).join('');
                        barContentHtml += `<div class="note-group-container sixteenth-eighth-group">${notesHtml}</div>`;
                    } else if (noteData.type === 'mixed-eighth-sixteenth') {
                        const firstNoteHtml = createNoteBlockHtml(noteData.notes[0], isBass, currentKey);
                        const secondNoteHtml = createNoteBlockHtml(noteData.notes[1], isBass, currentKey);
                        const thirdNoteHtml = createNoteBlockHtml(noteData.notes[2], isBass, currentKey);
                        const noteSixteenthGroupHtml = `<div class="note-group-container sixteenth-notes">${secondNoteHtml}${thirdNoteHtml}</div>`;
                        barContentHtml += `<div class="combined-note-group">${firstNoteHtml}${noteSixteenthGroupHtml}</div>`;
                    } else if (noteData.type === 'group' || noteData.type === 'triplet') {
                        const hasStaccato = noteData.notes.some(n => n.isStaccato);
                        const staccatoClass = hasStaccato ? '' : 'no-staccato';
                        const groupClass = noteData.type === 'triplet' ? 'triplet' : (noteData.notes.length === 2 ? 'eighth-notes' : 'sixteenth-notes');
                        let groupHtml = noteData.notes.map(n => createNoteBlockHtml(n, isBass, currentKey)).join('');
                        barContentHtml += `<div class="note-group-container ${groupClass} ${staccatoClass}">${groupHtml}</div>`;
                    } else {
                        barContentHtml += createNoteBlockHtml(noteData, isBass, currentKey);
                    }
                });
            }
            return barContentHtml;
        }

        function renderCombinedSheet() {
            combinedSheetContainer.querySelectorAll('.page, .music-row-wrapper').forEach(el => el.remove());
            
            if (layers.length === 0 || layers.every(l => l.notation.trim() === '')) {
                if(!combinedSheetContainer.querySelector('.placeholder-text')) {
                    const placeholder = document.createElement('p');
                    placeholder.className = 'placeholder-text text-gray-500 text-2xl font-bold p-4 text-center opacity-50';
                    placeholder.textContent = 'PRATINJAU KOSONG';
                    combinedSheetContainer.appendChild(placeholder);
                }
                combinedSheetContainer.appendChild(fullscreenBtn);
                return;
            } else {
                const placeholder = combinedSheetContainer.querySelector('.placeholder-text');
                if(placeholder) placeholder.remove();
            }

            const fontSizeValue = parseFloat(fontSizeSelect.value) || 1.2;
            const initialBirama = biramaSelect.value;
            let currentKey = tonalitasSelect.value;

            const allLayersBars = layers.map(layer => {
                if (layer.instrument === 'text') return [{ notes: [], annotations: [] }];
                return getBars(layer.notation, initialBirama, layer.instrument === 'accomp');
            });
            const annotationBars = layers.length > 0 ? allLayersBars[0] : [];
            const maxBars = Math.max(0, ...allLayersBars.map(bars => bars.length));

            if (maxBars === 0) {
                 if(!combinedSheetContainer.querySelector('.placeholder-text')) {
                    const placeholder = document.createElement('p');
                    placeholder.className = 'placeholder-text text-gray-500 text-2xl font-bold p-4 text-center opacity-50';
                    placeholder.textContent = 'PRATINJAU KOSONG';
                    combinedSheetContainer.appendChild(placeholder);
                }
                combinedSheetContainer.appendChild(fullscreenBtn);
                return;
            }

            const allRowWrappers = [];
            const layoutGuideLayer = layers[0];
            const globalBarsPerRow = parseInt(barsPerRowSelect.value);
            let barCursor = 0;
            let rowIndex = 0;

            while (barCursor < maxBars) {
                const barsInThisRow = layoutGuideLayer.rowOverrides[rowIndex] || globalBarsPerRow;
                const endOfRowCursor = Math.min(barCursor + barsInThisRow, maxBars);
                const rowBarsCount = endOfRowCursor - barCursor;
                if (rowBarsCount === 0) break;

                const rowWrapper = document.createElement('div');
                rowWrapper.className = 'music-row-wrapper';
                rowWrapper.dataset.rowIndex = rowIndex;

                const rowDiv = document.createElement('div');
                rowDiv.className = 'music-row';

                for(let i = 0; i < rowBarsCount; i++) {
                    const barIndex = barCursor + i;
                    const musicBarDiv = document.createElement('div');
                    musicBarDiv.className = 'music-bar';
                    musicBarDiv.dataset.barIndex = barIndex;

                    const annotationData = annotationBars[barIndex];
                    if (annotationData) {
                        const directivesContainer = document.createElement('div');
                        directivesContainer.className = 'notation-directives-container';
                        if (annotationData.newKey) {
                            currentKey = annotationData.newKey;
                            const keyChangeDiv = document.createElement('div');
                            keyChangeDiv.className = 'notation-directive';
                            keyChangeDiv.textContent = `Do = ${currentKey}`;
                            directivesContainer.appendChild(keyChangeDiv);
                        }
                        if (annotationData.newTimeSignature) {
                            const timeSigChangeDiv = document.createElement('div');
                            timeSigChangeDiv.className = 'notation-directive';
                            timeSigChangeDiv.textContent = `B = ${annotationData.newTimeSignature}`;
                            directivesContainer.appendChild(timeSigChangeDiv);
                        }
                        if (directivesContainer.childElementCount > 0) {
                            musicBarDiv.appendChild(directivesContainer);
                        }

                        if (annotationData.annotations.length > 0 && layers[0].instrument !== 'accomp') {
                            if (annotationData.annotations.includes('[')) musicBarDiv.classList.add('repeat-start');
                            if (annotationData.annotations.includes(']')) musicBarDiv.classList.add('repeat-end');
                            
                            let voltaType = null;
                            if (annotationData.annotations.includes('_a')) voltaType = '_a';
                            else if (annotationData.annotations.includes('_b')) voltaType = '_b';
                            else if (annotationData.annotations.includes('_c')) voltaType = '_c';
                            else if (annotationData.annotations.includes('_d')) voltaType = '_d';

                            if (voltaType) {
                                const voltaDiv = document.createElement('div');
                                voltaDiv.className = 'volta-bracket';
                                let voltaText = '';
                                switch (voltaType) {
                                    case '_a': voltaText = '1.'; break;
                                    case '_b': voltaText = '2.'; break;
                                    case '_c': voltaText = '3.'; break;
                                    case '_d': voltaText = '4.'; break;
                                }
                                voltaDiv.textContent = voltaText;
                                
                                const nextBarAnnotation = annotationBars[barIndex + 1];
                                if (!nextBarAnnotation || !nextBarAnnotation.annotations.includes(voltaType)) {
                                    voltaDiv.classList.add('is-end');
                                    const endHook = document.createElement('div');
                                    endHook.className = 'volta-bracket-end-hook';
                                    voltaDiv.appendChild(endHook);
                                }
                                musicBarDiv.appendChild(voltaDiv);
                                musicBarDiv.classList.add('has-volta');
                            }
                        }
                    }
                    
                    const barNumberSpan = document.createElement('span');
                    barNumberSpan.className = 'bar-number';
                    barNumberSpan.textContent = barIndex + 1;
                    musicBarDiv.appendChild(barNumberSpan);

                    if (i === rowBarsCount - 1 && !musicBarDiv.classList.contains('repeat-end')) {
                        musicBarDiv.style.borderRight = `calc(2px * var(--zoom-factor)) solid #64748b`;
                    }
                    
                    const displayOrderLayers = layers
                        .map((layer, index) => ({ layer, bars: allLayersBars[index], originalIndex: index }))
                        .sort((a, b) => {
                            if (a.layer.instrument === 'accomp') return -1;
                            if (b.layer.instrument === 'accomp') return 1;
                            if (a.layer.instrument === 'text') return 1; 
                            if (b.layer.instrument === 'text') return -1;
                            return a.originalIndex - b.originalIndex;
                        });

                    displayOrderLayers.forEach(({ layer, bars }) => {
                        if (layer.instrument === 'text') return;

                        const layerBarNotesDiv = document.createElement('div');
                        layerBarNotesDiv.className = 'layer-bar-notes';
                        const barData = bars[barIndex];
                        if (barData) {
                            layerBarNotesDiv.innerHTML = generateBarContentHtml(barData.notes, layer, currentKey);
                        }
                        musicBarDiv.appendChild(layerBarNotesDiv);
                    });

                    rowDiv.appendChild(musicBarDiv);
                }
                
                // Add text layers after the music row
                layers.filter(l => l.instrument === 'text').forEach(textLayer => {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'layer-text-notes';
                    const textLines = textLayer.notation.split('\n');
                    textDiv.innerHTML = textLines.map(line => `<p>${line || '&nbsp;'}</p>`).join('');
                    rowWrapper.appendChild(textDiv);
                });

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'row-layout-controls';
                controlsDiv.innerHTML = `
                    <button class="row-layout-btn" data-action="decrease" title="Kurangi bar di baris ini">-</button>
                    <span class="font-mono w-6 text-center">${barsInThisRow}</span>
                    <button class="row-layout-btn" data-action="increase" title="Tambah bar di baris ini">+</button>`;
                
                rowWrapper.appendChild(rowDiv);
                rowWrapper.appendChild(controlsDiv);
                allRowWrappers.push(rowWrapper);

                barCursor = endOfRowCursor;
                rowIndex++;
            }

            let currentPage;
            let currentPageContent;
            let pageNumber = 0;

            const createNewPage = () => {
                pageNumber++;
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                
                pageDiv.style.setProperty('--zoom-factor', fontSizeValue);
                
                if (pageNumber === 1) {
                    const titleValue = titleInput.value || 'Judul Lagu';
                    const composerValue = composerInput.value || '-';
                    const arrangerValue = arrangerInput.value || '-';
                    const bpmValue = bpmInput.value;
                    const biramaValue = biramaSelect.value;
                    const tonalitasText = `Do = ${tonalitasSelect.value}`;

                    pageDiv.innerHTML = `
                        <div class="song-title">${titleValue}</div>
                        <div class="header-info">
                            <div>
                                <p style="font-weight: 600;">${tonalitasText}</p>
                                <p>Birama: ${biramaValue}</p>
                            </div>
                            <div id="tempo-display" style="text-align: center; flex-grow: 1;">
                                <p style="font-weight: 500;"><span style="font-family: 'Times New Roman', serif; font-size: 1.5em; vertical-align: middle; line-height: 1;">♩</span> = ${bpmValue}</p>
                            </div>
                            <div style="text-align: right;">
                                <p>Komposer: ${composerValue}</p>
                                <p>Arranger: ${arrangerValue}</p>
                            </div>
                        </div>
                    `;
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'page-content';
                pageDiv.appendChild(contentDiv);
                
                combinedSheetContainer.insertBefore(pageDiv, fullscreenBtn);
                currentPage = pageDiv;
                currentPageContent = contentDiv;
                void currentPage.offsetHeight;
            };

            createNewPage();

            allRowWrappers.forEach(row => {
                currentPageContent.appendChild(row);
                if (currentPage.scrollHeight > currentPage.clientHeight && currentPageContent.childElementCount > 1) {
                    row.remove();
                    createNewPage();
                    currentPageContent.appendChild(row);
                }
            });
            
            const allRenderedPages = combinedSheetContainer.querySelectorAll('.page');
            allRenderedPages.forEach(page => {
                if (!page.querySelector('.page-watermark')) {
                    const watermarkDiv = document.createElement('div');
                    watermarkDiv.className = 'page-watermark';
                    watermarkDiv.textContent = 'Dibuat dengan ABIMANTRA NOT ANGKA | by Yoga Andika';
                    page.appendChild(watermarkDiv);
                }
            });
            
            setTimeout(() => {
                const allPages = combinedSheetContainer.querySelectorAll('.page');
                allPages.forEach(page => {
                    const pageContent = page.querySelector('.page-content');
                    if (!pageContent) return;
                    const availableWidth = pageContent.clientWidth;
                    if (availableWidth === 0) return;

                    const standardBarWidth = availableWidth / globalBarsPerRow;
                    const rowWrappers = page.querySelectorAll('.music-row-wrapper');

                    rowWrappers.forEach(wrapper => {
                        const rowIndex = parseInt(wrapper.dataset.rowIndex);
                        const barsInThisRow = wrapper.querySelectorAll('.music-bar');

                        if (layers[0] && layers[0].rowOverrides[rowIndex]) {
                            const customBarWidth = availableWidth / barsInThisRow.length;
                            barsInThisRow.forEach(bar => { bar.style.width = `${customBarWidth}px`; });
                        } else {
                            barsInThisRow.forEach(bar => { bar.style.width = `${standardBarWidth}px`; });
                        }
                    });
                });
            }, 0);
        }

        function renderEditorView() {
            layersEditorContainer.innerHTML = '';
            layers.forEach((layer, index) => {
                const editorRow = document.createElement('div');
                editorRow.className = `layer-editor-row ${layer.isEditorHidden ? 'is-collapsed' : ''}`;
                editorRow.dataset.index = index;
                
                const removeButtonHtml = index > 0 || layers.length > 1 ? `<button class="remove-btn">Hapus</button>` : '';

                let editorHtml;
                if (layer.instrument === 'text') {
                    editorHtml = `<div class="editor-wrapper text-editor-wrapper"><textarea class="text-notation-editor" spellcheck="true" placeholder="Masukkan lirik atau catatan di sini..."></textarea></div>`;
                } else {
                    editorHtml = `<div class="editor-wrapper"><div class="layer-notation-bar-numbers"></div><textarea class="layer-notation-editor" spellcheck="false" placeholder="${layer.instrument === 'accomp' ? 'C G Am F z...' : '1 2 3 4...'}"></textarea></div>`;
                }

                editorRow.innerHTML = `
                    <div class="layer-editor-header flex items-center justify-between gap-4 w-full">
                        <div class="flex items-center gap-2">
                           <h3 class="font-bold text-gray-200" style="color: var(--text-headings)">Layer ${index + 1}</h3>
                           <span class="instrument-name text-sm text-gray-600" style="color: var(--text-secondary)">(${layer.instrument})</span>
                        </div>
                        <svg class="h-4 w-4 text-gray-500 transition-transform duration-200" style="transform: rotate(${layer.isEditorHidden ? '-90deg' : '0deg'});" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="editor-and-controls flex flex-col sm:flex-row gap-4 w-full">
                        <div class="flex flex-col gap-2 self-start w-full sm:w-auto">
                            <label class="font-semibold text-gray-500" style="color: var(--text-secondary)">Instrumen</label>
                            <select class="layer-instrument-select w-full">
                                <option value="piano">Piano</option> 
                                <option value="flute">Flute</option> 
                                <option value="bass">Bass</option>
                                <option value="accomp">Accomp</option>
                                <option value="text">Teks</option>
                            </select>
                        </div>
                        ${editorHtml}
                        ${removeButtonHtml}
                    </div>
                `;
                
                const instrumentSelect = editorRow.querySelector('.layer-instrument-select');
                instrumentSelect.value = layer.instrument;
                
                const editorTextarea = editorRow.querySelector('textarea');
                if (editorTextarea) {
                    editorTextarea.value = layer.notation;
                    if (layer.instrument !== 'text') {
                        const formatterDiv = editorRow.querySelector('.layer-notation-bar-numbers');
                        formatterDiv.innerHTML = formatNotationWithAutoBars(editorTextarea.value, biramaSelect.value);
                    }
                }
                
                layersEditorContainer.appendChild(editorRow);
            });
        }
        
        function renderAll() {
            renderCombinedSheet();
            renderEditorView();
            updateUndoRedoButtons();
        }
        
        // --- AUDIO PLAYBACK ---
        function processNotesForPlayback(notation, initialBirama, initialKey) {
            const keyChangeRegex = /\(Do=([A-G][b#]?)\)/i;
            const timeSigChangeRegex = /\(B=(\d{1,2}\/\d{1,2})\)/i;
            const directiveRegex = /(\([Bb]=[\d\/]+\)|\(Do=[A-Ga-g][b#]?\))/g;

            const tokens = notation.replace(directiveRegex, ' $1 ').replace(/\|/g, ' ').split(/\s+/g).filter(Boolean);

            const timedEvents = [];
            let currentTime = 0; // in quarter notes
            let currentBirama = initialBirama;
            let currentKey = initialKey;

            const noteRegex = /([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)/g;
            const mixedNoteRegex = /^([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)-([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)$/;
            const sixteenthEighthRegex = /^([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)([1-7o0])([\/b]?)([.,]*)(\^?)(\~?)-$/;

            for (const token of tokens) {
                 if (['[', ']', '_a', '_b', '_c', '_d'].includes(token)) continue;

                const keyMatch = token.match(keyChangeRegex);
                if (keyMatch) {
                    currentKey = keyMatch[1];
                    continue;
                }

                const timeSigMatch = token.match(timeSigChangeRegex);
                if (timeSigMatch) {
                    currentBirama = timeSigMatch[1];
                    continue;
                }
                
                const createNoteEvent = (noteData, duration) => {
                    const event = {
                        time: currentTime,
                        type: 'note',
                        key: currentKey,
                        duration: duration,
                        data: noteData
                    };
                    timedEvents.push(event);
                    currentTime += duration;
                }

                const mixedNotesMatch = token.match(mixedNoteRegex);
                const sixteenthEighthMatch = token.match(sixteenthEighthRegex);

                if (sixteenthEighthMatch) {
                     const [_, n1, a1, o1, s1, f1, n2, a2, o2, s2, f2, n3, a3, o3, s3, f3] = sixteenthEighthMatch;
                     createNoteEvent({ visualNote: n1, visualSharp: a1 === '/', visualFlat: a1 === 'b', visualModifier: o1, isStaccato: s1.includes('^'), isFermata: f1.includes('~') }, 0.25);
                     createNoteEvent({ visualNote: n2, visualSharp: a2 === '/', visualFlat: a2 === 'b', visualModifier: o2, isStaccato: s2.includes('^'), isFermata: f2.includes('~') }, 0.25);
                     createNoteEvent({ visualNote: n3, visualSharp: a3 === '/', visualFlat: a3 === 'b', visualModifier: o3, isStaccato: s3.includes('^'), isFermata: f3.includes('~') }, 0.5);
                } else if (mixedNotesMatch) {
                    const [_, n1, a1, o1, s1, f1, n2, a2, o2, s2, f2, n3, a3, o3, s3, f3] = mixedNotesMatch;
                    createNoteEvent({ visualNote: n1, visualSharp: a1 === '/', visualFlat: a1 === 'b', visualModifier: o1, isStaccato: s1.includes('^'), isFermata: f1.includes('~') }, 0.5);
                    createNoteEvent({ visualNote: n2, visualSharp: a2 === '/', visualFlat: a2 === 'b', visualModifier: o2, isStaccato: s2.includes('^'), isFermata: f2.includes('~') }, 0.25);
                    createNoteEvent({ visualNote: n3, visualSharp: a3 === '/', visualFlat: a3 === 'b', visualModifier: o3, isStaccato: s3.includes('^'), isFermata: f3.includes('~') }, 0.25);
                } else {
                    const notesInToken = [...token.matchAll(noteRegex)];
                    if (notesInToken.length === 2) {
                        notesInToken.forEach(m => { const [_, note, acc, oct, stac, fermata] = m; createNoteEvent({ visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~') }, 0.5); });
                    } else if (notesInToken.length === 3) {
                         notesInToken.forEach(m => { const [_, note, acc, oct, stac, fermata] = m; createNoteEvent({ visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~') }, 1/3); });
                    } else if (notesInToken.length === 4) {
                         notesInToken.forEach(m => { const [_, note, acc, oct, stac, fermata] = m; createNoteEvent({ visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~') }, 0.25); });
                    } else if (notesInToken.length > 0) {
                        const [_, note, acc, oct, stac, fermata] = notesInToken[0];
                        createNoteEvent({ visualNote: note, visualSharp: acc === '/', visualFlat: acc === 'b', visualModifier: oct, isStaccato: stac.includes('^'), isFermata: fermata.includes('~') }, 1);
                    }
                }
            }
            return timedEvents;
        }

        async function playAllLayers() {
            if (Tone.Transport.state === "started") { Tone.Transport.stop(); playBtn.textContent = 'Mainkan'; fullscreenPlayPauseBtn.classList.remove('playing'); stopHighlight(); return; }
            await Tone.start(); Tone.Transport.stop(); Tone.Transport.cancel(0); // [PERBAIKAN] Selalu reset transport
            
            const bpm = parseInt(bpmInput.value); Tone.Transport.bpm.value = bpm;
            const initialKey = tonalitasSelect.value;
            const initialBirama = biramaSelect.value;
            let maxDuration = 0;
            
            layers.forEach(layer => {
                if (layer.instrument === 'accomp' || layer.instrument === 'text' || !layer.notation) return; 

                const timedEvents = processNotesForPlayback(layer.notation, initialBirama, initialKey);
                if (timedEvents.length === 0) return;

                const player = TonePlayers[layer.instrument]; if (!player) return;
                
                const partEvents = timedEvents.map(event => {
                    const toneNote = getToneNote(event.data, layer, event.key);
                    const quarterNoteDuration = Tone.Time('4n').toSeconds();
                    return {
                        time: event.time * quarterNoteDuration,
                        note: toneNote,
                        duration: event.duration * quarterNoteDuration
                    };
                }).filter(e => e.note); // Filter out rests

                if (partEvents.length > 0) {
                    new Tone.Part((time, value) => {
                        player.triggerAttackRelease(value.note, value.duration, time);
                    }, partEvents).start(0);
                    const lastEvent = partEvents[partEvents.length - 1];
                    maxDuration = Math.max(maxDuration, lastEvent.time + lastEvent.duration);
                }
            });

            if (maxDuration > 0) {
                Tone.Transport.scheduleOnce(() => { playBtn.textContent = 'Mainkan'; fullscreenPlayPauseBtn.classList.remove('playing'); Tone.Transport.stop(); stopHighlight(); }, maxDuration);
                Tone.Transport.start(); playBtn.textContent = 'Stop'; fullscreenPlayPauseBtn.classList.add('playing'); startHighlight(initialBirama);
            } else { showMessageBox('Tidak ada notasi valid untuk dimainkan.', 'error'); }
        }

        function stopPlayback() {
            if (Tone.Transport.state === "started") {
                Tone.Transport.stop();
                playBtn.textContent = 'Mainkan';
                fullscreenPlayPauseBtn.classList.remove('playing');
                stopHighlight();
                showMessageBox('Pemutaran dihentikan.', 'success');
            } else {
                showMessageBox('Tidak ada musik yang sedang dimainkan.', 'error');
            }
        }
        
        function getToneNote(noteData, layer, currentKey) {
            const majorScaleIntervals = { '1': 0, '2': 2, '3': 4, '4': 5, '5': 7, '6': 9, '7': 11 };
            if (majorScaleIntervals[noteData.visualNote] === undefined) return null; // Rest note

            let interval = majorScaleIntervals[noteData.visualNote];
            
            let octave = layer.instrument === 'bass' ? 3 : 4; 
            if (noteData.visualModifier === '.') octave++;
            else if (noteData.visualModifier === '..') octave += 2;
            else if (noteData.visualModifier === ',') octave--;
            else if (noteData.visualModifier === ',,') octave -= 2;
            
            const tonic = currentKey + octave;

            if (noteData.visualSharp) interval += 1;
            else if (noteData.visualFlat) interval -= 1;
            
            return Tone.Frequency(tonic).transpose(interval).toNote();
        }

        function startHighlight(initialBirama) {
            stopHighlight(); // Clear any previous highlight schedules

            const allBars = getBars(layers[0]?.notation || '', initialBirama);
            if (allBars.length === 0) return;

            let timeCursor = 0; // in seconds
            const quarterNoteDuration = Tone.Time('4n').toSeconds();
            
            allBars.forEach((bar, index) => {
                const scheduleId = Tone.Transport.scheduleOnce(time => {
                    Tone.Draw.schedule(() => {
                        document.querySelectorAll('.music-bar').forEach(b => b.style.backgroundColor = 'transparent');
                        const barToHighlight = document.querySelector(`.music-bar[data-bar-index="${index}"]`);
                        if (barToHighlight) {
                            barToHighlight.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
                            barToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                        }
                    }, time);
                }, timeCursor);
                
                highlightBarIntervalId.push(scheduleId); // Store the schedule ID

                let barDuration = 0;
                bar.notes.forEach(note => barDuration += note.duration);
                timeCursor += barDuration * quarterNoteDuration;
            });
        }
        
        function stopHighlight() {
            if (highlightBarIntervalId && highlightBarIntervalId.length > 0) {
                highlightBarIntervalId.forEach(id => Tone.Transport.clear(id));
            }
            highlightBarIntervalId = [];
            document.querySelectorAll('.music-bar').forEach(bar => bar.style.backgroundColor = 'transparent');
        }

        function toggleEditorWindow(action) {
            const floatingWindow = document.getElementById('floating-editor-window');
            const showEditorButton = document.getElementById('show-editor-button');
            if (action === 'minimize') {
                floatingWindow.classList.add('is-minimized');
                showEditorButton.classList.add('is-visible');
            } else if (action === 'maximize') {
                floatingWindow.classList.remove('is-minimized');
                showEditorButton.classList.remove('is-visible');
            }
        }
        
        function toggleInstructionsWindow() {
            const instructionsPanel = document.getElementById('instructions-panel');
            instructionsPanel.classList.toggle('is-minimized');
            const showBtn = document.getElementById('maximize-instructions-btn');
            const hideBtn = document.getElementById('minimize-instructions-btn');

            if (instructionsPanel.classList.contains('is-minimized')) {
                showBtn.style.display = 'flex';
                hideBtn.style.display = 'none';
            } else {
                showBtn.style.display = 'none';
                hideBtn.style.display = 'flex';
            }
        }
        
        // --- LAYER MANAGEMENT ---
        function addLayer() {
            layers.push({ 
                instrument: 'piano', 
                notation: '', 
                chordNotation: '',
                history: [''], 
                historyIndex: 0, 
                rowOverrides: {},
                isEditorHidden: false
            });
            activeLayerIndex = layers.length - 1;
            renderAll();
        }
        
        function removeLayer(index) {
            if (layers.length <= 1) {
                showMessageBox("Tidak bisa menghapus layer terakhir.", "error");
                return;
            }
            layers.splice(index, 1);
            if (activeLayerIndex >= layers.length) {
                activeLayerIndex = layers.length > 0 ? layers.length - 1 : null;
            } else if (layers.length > 0 && activeLayerIndex > index) {
                activeLayerIndex--;
            } else if (activeLayerIndex === index) {
                activeLayerIndex = Math.min(index, layers.length - 1);
            }
            renderAll();
        }

        function startNewProject() {
            titleInput.value = '';
            composerInput.value = '';
            arrangerInput.value = '';
            bpmInput.value = '120';
            tonalitasSelect.value = 'C';
            biramaSelect.value = '4/4';
            barsPerRowSelect.value = '4';
            fontSizeSelect.value = '1.2';
            fullscreenFontSizeSelect.value = '1.2';
            setNormalStyle();

            layers = [];
            addLayer();

            renderAll();
            showMessageBox('Proyek baru berhasil dimulai.', 'success');
        }
        
        // --- PROJECT SAVE & LOAD ---
        function saveProject() {
            try {
                const projectData = {
                    title: titleInput.value,
                    bpm: bpmInput.value,
                    birama: biramaSelect.value,
                    tonalitas: tonalitasSelect.value,
                    composer: composerInput.value,
                    arranger: arrangerInput.value,
                    globalBarsPerRow: barsPerRowSelect.value,
                    fontSize: fontSizeSelect.value,
                    fontStyle: fontStyle, // Save font style state
                    layers: layers.map(l => ({
                        instrument: l.instrument,
                        notation: l.notation,
                        rowOverrides: l.rowOverrides || {},
                        isEditorHidden: l.isEditorHidden || false
                    }))
                };

                const jsonString = JSON.stringify(projectData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                const titleValue = titleInput.value.trim().replace(/\s+/g, '-') || 'proyek-tanpa-judul';
                a.download = `${titleValue}.abimantra`;
                a.href = url;
                a.click();

                URL.revokeObjectURL(url);
                showMessageBox('Proyek berhasil disimpan!', 'success');
            } catch (error) {
                console.error("Gagal menyimpan proyek:", error);
                showMessageBox('Gagal menyimpan proyek.', 'error');
            }
        }

        function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);

                    if (!projectData.layers || !Array.isArray(projectData.layers)) {
                        throw new Error("Format file proyek tidak valid.");
                    }

                    titleInput.value = projectData.title || '';
                    bpmInput.value = projectData.bpm || '120';
                    biramaSelect.value = projectData.birama || '4/4';
                    tonalitasSelect.value = projectData.tonalitas || 'C';
                    composerInput.value = projectData.composer || '';
                    arrangerInput.value = projectData.arranger || '';
                    barsPerRowSelect.value = projectData.globalBarsPerRow || '4';
                    fontSizeSelect.value = projectData.fontSize || '1.2';
                    fullscreenFontSizeSelect.value = fontSizeSelect.value;
                    
                    fontStyle = projectData.fontStyle || { bold: false, italic: false };
                    applyFontStyle();

                    layers = projectData.layers.map(l => ({
                        instrument: l.instrument || 'piano',
                        notation: l.notation || '',
                        history: [l.notation || ''],
                        historyIndex: 0,
                        rowOverrides: l.rowOverrides || {},
                        isEditorHidden: l.isEditorHidden || false
                    }));
                    
                    if (layers.length === 0) {
                       addLayer();
                    } else {
                       activeLayerIndex = 0;
                       renderAll();
                    }

                    showMessageBox('Proyek berhasil dimuat!', 'success');

                } catch (error) {
                    console.error("Gagal memuat proyek:", error);
                    showMessageBox(`Gagal memuat proyek: ${error.message}`, 'error');
                } finally {
                    event.target.value = null;
                }
            };

            reader.onerror = function() {
                showMessageBox('Gagal membaca file.', 'error');
            };

            reader.readAsText(file);
        }

        // --- VIEW & EXPORT FUNCTIONALITY ---
        function togglePseudoFullscreen() {
            const body = document.body;
            const iconEnter = document.getElementById('fullscreen-enter-icon');
            const iconExit = document.getElementById('fullscreen-exit-icon');
            body.classList.toggle('fullscreen-mode');

            if (body.classList.contains('fullscreen-mode')) {
                iconEnter.classList.add('hidden');
                iconExit.classList.remove('hidden');
            } else {
                iconEnter.classList.remove('hidden');
                iconExit.classList.add('hidden');
                stopPlayback();
            }
        }

        async function downloadAsPng() {
            downloadPngBtn.disabled = true;
            downloadPngBtn.textContent = 'Memproses...';
            fullscreenDownloadPngBtn.disabled = true;

            const allControls = document.querySelectorAll('.row-layout-controls, #fullscreen-btn, #floating-editor-window, #show-editor-button, #fullscreen-controls');
            allControls.forEach(c => c.style.visibility = 'hidden');

            try {
                const pages = document.querySelectorAll('#combined-sheet-container .page');
                if (pages.length === 0) {
                    showMessageBox('Tidak ada notasi untuk diunduh.', 'error');
                    return;
                }

                const pageCanvases = await Promise.all(
                    Array.from(pages).map(page => html2canvas(page, {
                        scale: 3, useCORS: true, backgroundColor: null
                    }))
                );

                const margin = 30;
                const totalHeight = pageCanvases.reduce((sum, canvas) => sum + canvas.height, 0) + (margin * (pageCanvases.length - 1));
                const maxWidth = Math.max(...pageCanvases.map(c => c.width));

                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = maxWidth;
                finalCanvas.height = totalHeight;
                const ctx = finalCanvas.getContext('2d');
                
                ctx.fillStyle = getComputedStyle(document.getElementById('combined-sheet-container')).getPropertyValue('background-color');
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                let currentY = 0;
                pageCanvases.forEach(canvas => {
                    const xOffset = (maxWidth - canvas.width) / 2;
                    ctx.drawImage(canvas, xOffset, currentY);
                    currentY += canvas.height + margin;
                });

                const watermarkText = "Dibuat dengan ABIMANTRA NOT ANGKA | by Yoga Andika";
                const fontSize = finalCanvas.width * 0.015;
                ctx.font = `600 ${fontSize}px Poppins, sans-serif`;
                
                const isDarkMode = document.body.classList.contains('dark');
                ctx.fillStyle = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
                
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';
                
                const padding = finalCanvas.width * 0.02;
                ctx.fillText(watermarkText, finalCanvas.width - padding, finalCanvas.height - padding);

                const titleValue = titleInput.value || 'notasi-lagu';
                const image = finalCanvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = `${titleValue.toLowerCase().replace(/\s/g, '-')}.png`;
                link.href = image;
                link.click();
                showMessageBox('PNG berhasil diunduh!', 'success');

            } catch (error) {
                console.error("Gagal mengunduh gambar:", error);
                showMessageBox('Gagal membuat file PNG.', 'error');
            } finally {
                downloadPngBtn.disabled = false;
                downloadPngBtn.textContent = 'Unduh PNG';
                fullscreenDownloadPngBtn.disabled = false;
                allControls.forEach(c => c.style.visibility = '');
            }
        }

        async function downloadAsPdf() {
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.textContent = 'Memproses...';
            fullscreenDownloadPdfBtn.disabled = true;

            const allControls = document.querySelectorAll('.row-layout-controls, #fullscreen-btn, #floating-editor-window, #show-editor-button, #fullscreen-controls');
            allControls.forEach(c => c.style.visibility = 'hidden');
            document.querySelectorAll('.page-watermark').forEach(wm => wm.classList.add('pdf-export-hidden'));

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                const pages = document.querySelectorAll('#combined-sheet-container .page');
                if (pages.length === 0) {
                    showMessageBox('Tidak ada notasi untuk diunduh.', 'error');
                    return;
                }

                const watermarkText = 'Dibuat dengan ABIMANTRA NOT ANGKA | by Yoga Andika';
                const fontSize = 8;
                const watermarkColor = 150;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 10;
                
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    const canvas = await html2canvas(page, {
                        scale: 3,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = doc.getImageProperties(imgData);
                    
                    const availableWidth = pageWidth - margin * 2;
                    const availableHeight = pageHeight - margin * 2;
                    const imgRatio = imgProps.width / imgProps.height;
                    const pageRatio = availableWidth / availableHeight;
                    let finalWidth, finalHeight;
                    
                    if (imgRatio > pageRatio) {
                        finalWidth = availableWidth;
                        finalHeight = availableWidth / imgRatio;
                    } else {
                        finalHeight = availableHeight;
                        finalWidth = availableHeight * imgRatio;
                    }

                    const x = (pageWidth - finalWidth) / 2;
                    const y = (pageHeight - finalHeight) / 2;

                    if (i > 0) {
                        doc.addPage();
                    }
                    doc.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                    
                    doc.setFontSize(fontSize);
                    doc.setTextColor(watermarkColor);
                    doc.text(watermarkText, pageWidth - margin, pageHeight - margin, { align: 'right' });
                }
                
                const titleValue = titleInput.value || 'notasi-lagu';
                doc.save(`${titleValue.toLowerCase().replace(/\s/g, '-')}.pdf`);
                showMessageBox('PDF berhasil diunduh!', 'success');

            } catch (error) {
                console.error("Gagal mengunduh PDF:", error);
                showMessageBox('Gagal membuat file PDF.', 'error');
            } finally {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.textContent = 'Unduh PDF';
                fullscreenDownloadPdfBtn.disabled = false;
                allControls.forEach(c => c.style.visibility = '');
                document.querySelectorAll('.page-watermark').forEach(wm => wm.classList.remove('pdf-export-hidden'));
            }
        }
        
        // --- EDITOR FORMATTING & CURSOR MANAGEMENT ---
        function formatNotationWithAutoBars(notation, biramaValue) {
            const beatsPerBar = parseInt(biramaValue.split('/')[0]);
            if (isNaN(beatsPerBar) || beatsPerBar <= 0) return notation;

            const getNoteDuration = (token) => { return (token.match(/[1-7o0]/g) || []).length > 0 ? 1 : 0; };
            const htmlPrefix = `<span class="editor-bar-number" style="position: absolute; bottom: 100%; left: 0.75rem; transform: translateX(0.25ch); padding-top: 0.2rem;">1</span>`;
            const escapedNotation = notation.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const parts = escapedNotation.replace(/\|/g, ' ').split(/(\s+)/);
            let htmlOutput = '';
            let beatCounter = 0;
            let barNumber = 2;
            let barLinePending = false;

            for (const part of parts) {
                if (part.trim() !== '') {
                    if (barLinePending) {
                        htmlOutput += `<span class="editor-auto-bar-line"><span class="editor-bar-number">${barNumber++}</span></span>`;
                        barLinePending = false;
                    }
                    htmlOutput += part;
                    beatCounter += getNoteDuration(part);
                } else {
                    htmlOutput += part;
                    if (beatCounter >= beatsPerBar) {
                        barLinePending = true;
                        beatCounter = 0;
                    }
                }
            }
            return htmlPrefix + htmlOutput;
        }

        // --- EVENT LISTENERS & INITIAL SETUP ---
        function addEventListeners() {
            addLayerBtn.addEventListener('click', addLayer);
            playBtn.addEventListener('click', playAllLayers);
            downloadPngBtn.addEventListener('click', downloadAsPng);
            downloadPdfBtn.addEventListener('click', downloadAsPdf);
            fullscreenBtn.addEventListener('click', togglePseudoFullscreen);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            
            newProjectBtn.addEventListener('click', () => showModal('new-project-modal'));
            confirmNewProjectBtn.addEventListener('click', () => { hideModal('new-project-modal'); startNewProject(); });
            cancelNewProjectBtn.addEventListener('click', () => hideModal('new-project-modal'));
            
            // Tempo Modal events
            confirmTempoBtn.addEventListener('click', () => {
                bpmInput.value = modalTempoInput.value;
                hideModal('tempo-modal');
                renderAll();
            });
            cancelTempoBtn.addEventListener('click', () => hideModal('tempo-modal'));
            
            // Main Controls
            [titleInput, composerInput, arrangerInput, biramaSelect, tonalitasSelect, bpmInput, barsPerRowSelect].forEach(el => { el.addEventListener('change', renderAll); });
            
            // Font Size Sync
            fontSizeSelect.addEventListener('change', () => {
                fullscreenFontSizeSelect.value = fontSizeSelect.value;
                renderAll();
            });
            fullscreenFontSizeSelect.addEventListener('change', () => {
                fontSizeSelect.value = fullscreenFontSizeSelect.value;
                renderAll();
            });

            // Font Style Controls
            fontNormalBtn.addEventListener('click', setNormalStyle);
            fontBoldBtn.addEventListener('click', () => toggleStyle('bold'));
            fontItalicBtn.addEventListener('click', () => toggleStyle('italic'));
            fullscreenFontNormalBtn.addEventListener('click', setNormalStyle);
            fullscreenFontBoldBtn.addEventListener('click', () => toggleStyle('bold'));
            fullscreenFontItalicBtn.addEventListener('click', () => toggleStyle('italic'));

            // Fullscreen Buttons
            fullscreenPlayPauseBtn.addEventListener('click', playAllLayers);
            fullscreenStopBtn.addEventListener('click', stopPlayback);
            fullscreenDownloadPngBtn.addEventListener('click', downloadAsPng);
            fullscreenDownloadPdfBtn.addEventListener('click', downloadAsPdf);
            fullscreenNewProjectBtn.addEventListener('click', () => { stopPlayback(); showModal('new-project-modal'); });
            fullscreenSaveProjectBtn.addEventListener('click', () => { stopPlayback(); saveProject(); });
            fullscreenLoadProjectBtn.addEventListener('click', () => { stopPlayback(); loadProjectInput.click(); });


            // Project Load/Save
            saveProjectBtn.addEventListener('click', saveProject);
            loadProjectBtn.addEventListener('click', () => loadProjectInput.click());
            loadProjectInput.addEventListener('change', loadProject);
            
            const viewModeControls = document.getElementById('view-mode-controls');
            viewModeControls.addEventListener('click', (e) => {
                const button = e.target.closest('.view-mode-btn');
                if (button) {
                    const viewMode = button.dataset.view;
                    const container = document.getElementById('combined-sheet-container');
                    
                    container.classList.remove('mobile-view', 'tablet-view', 'pc-view');
                    container.classList.add(`${viewMode}-view`);

                    viewModeControls.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    renderCombinedSheet();
                }
            });

            // Editor Logic
            document.body.addEventListener('input', (e) => {
                const isMusicalEditor = e.target.classList.contains('layer-notation-editor');
                const isTextEditor = e.target.classList.contains('text-notation-editor');
                if (!isMusicalEditor && !isTextEditor) return;
                
                const editorRow = e.target.closest('.layer-editor-row');
                if (!editorRow) return;
                const index = parseInt(editorRow.dataset.index);
                const editorTextarea = e.target;
                if (layers[index].notation !== editorTextarea.value) {
                    layers[index].notation = editorTextarea.value;
                    recordHistory(index, editorTextarea.value);
                    renderCombinedSheet();
                    if (isMusicalEditor) {
                        editorRow.querySelector('.layer-notation-bar-numbers').innerHTML = formatNotationWithAutoBars(editorTextarea.value, biramaSelect.value);
                    }
                }
            });

            document.body.addEventListener('keyup', (e) => {
                if (!e.target.classList.contains('layer-notation-editor')) return;
                const musicalNotes = ['1', '2', '3', '4', '5', '6', '7', 'o'];
                if (musicalNotes.includes(e.key)) {
                    const editorRow = e.target.closest('.layer-editor-row');
                    if (editorRow) {
                        const index = parseInt(editorRow.dataset.index);
                        playSingleNote(e.key, index);
                    }
                }
            });

            document.body.addEventListener('focusin', (e) => {
                const isMusicalEditor = e.target.classList.contains('layer-notation-editor');
                const isTextEditor = e.target.classList.contains('text-notation-editor');
                if (!isMusicalEditor && !isTextEditor) return;

                const editorRow = e.target.closest('.layer-editor-row');
                if (editorRow) {
                    activeLayerIndex = parseInt(editorRow.dataset.index);
                    updateUndoRedoButtons();
                }
            });

            document.body.addEventListener('change', (e) => {
                const editorRow = e.target.closest('.layer-editor-row'); 
                if (!editorRow) return;
                const index = parseInt(editorRow.dataset.index);
                if (e.target.classList.contains('layer-instrument-select')) {
                    const newInstrument = e.target.value;
                    layers[index].instrument = newInstrument;
                    renderAll();
                }
            });
            
            document.body.addEventListener('click', (e) => {
                // Tempo modal listener
                const tempoDisplay = e.target.closest('#tempo-display');
                if (tempoDisplay && document.body.classList.contains('fullscreen-mode')) {
                    modalTempoInput.value = bpmInput.value;
                    showModal('tempo-modal');
                }

                const header = e.target.closest('.layer-editor-header');
                if (header) {
                    const editorRow = header.closest('.layer-editor-row');
                    const index = parseInt(editorRow.dataset.index);
                    layers[index].isEditorHidden = !layers[index].isEditorHidden;
                    renderAll();
                }

                const removeBtn = e.target.closest('.remove-btn');
                if (removeBtn) {
                    const editorRow = removeBtn.closest('.layer-editor-row'); 
                    if (editorRow) removeLayer(parseInt(editorRow.dataset.index));
                }
            });

            document.body.addEventListener('scroll', (e) => {
                if (e.target.classList.contains('layer-notation-editor')) {
                    const formatter = e.target.previousElementSibling;
                    if (formatter) {
                        formatter.scrollTop = e.target.scrollTop;
                        formatter.scrollLeft = e.target.scrollLeft;
                    }
                }
            }, true);

            combinedSheetContainer.addEventListener('click', (e) => {
                 const button = e.target.closest('.row-layout-btn');
                if (button) {
                    const rowWrapper = button.closest('.music-row-wrapper');
                    if (!rowWrapper || layers.length === 0) return;
                    
                    const rowIndex = parseInt(rowWrapper.dataset.rowIndex);
                    const action = button.dataset.action;
                    const layoutGuideLayer = layers[0];
                    const globalBarsPerRow = parseInt(barsPerRowSelect.value);
                    let currentBars = layoutGuideLayer.rowOverrides[rowIndex] || globalBarsPerRow;

                    if (action === 'increase') { currentBars++; } 
                    else if (action === 'decrease') { currentBars = Math.max(1, currentBars - 1); }
                    
                    if (currentBars === globalBarsPerRow) { delete layoutGuideLayer.rowOverrides[rowIndex]; } 
                    else { layoutGuideLayer.rowOverrides[rowIndex] = currentBars; }
                    
                    renderCombinedSheet();
                }
            });

            // Keyboard Shortcuts for Font Style
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                if (e.metaKey || e.ctrlKey) {
                    if (e.key.toLowerCase() === 'b') {
                        e.preventDefault();
                        toggleStyle('bold');
                    }
                    if (e.key.toLowerCase() === 'i') {
                        e.preventDefault();
                        toggleStyle('italic');
                    }
                }
            });
        }

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = elmnt.querySelector(".floating-editor-header");
            if (header) header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event; e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event; e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }

        function makeResizable(elmnt) {
            const resizers = elmnt.querySelectorAll('.resizer');
            resizers.forEach(resizer => {
                resizer.addEventListener('mousedown', initResize);
                function initResize(e) {
                    e.preventDefault();
                    elmnt.style.transition = 'none';
                    let original_width = parseFloat(getComputedStyle(elmnt, null).getPropertyValue('width').replace('px', ''));
                    let original_height = parseFloat(getComputedStyle(elmnt, null).getPropertyValue('height').replace('px', ''));
                    let original_mouse_x = e.pageX;
                    let original_mouse_y = e.pageY;
                    let original_top = elmnt.offsetTop;
                    let original_left = elmnt.offsetLeft;
                    window.addEventListener('mousemove', doResize);
                    window.addEventListener('mouseup', stopResize);
                    
                    function doResize(e) {
                        const minWidth = 300; const minHeight = 200;
                        if (resizer.classList.contains('resizer-r') || resizer.classList.contains('resizer-rt') || resizer.classList.contains('resizer-rb')) {
                            const width = original_width + (e.pageX - original_mouse_x);
                            if (width > minWidth) { elmnt.style.width = width + 'px'; }
                        }
                        if (resizer.classList.contains('resizer-b') || resizer.classList.contains('resizer-bl') || resizer.classList.contains('resizer-rb')) {
                            const height = original_height + (e.pageY - original_mouse_y);
                            if (height > minHeight) { elmnt.style.height = height + 'px'; }
                        }
                        if (resizer.classList.contains('resizer-l') || resizer.classList.contains('resizer-lt') || resizer.classList.contains('resizer-bl')) {
                            const width = original_width - (e.pageX - original_mouse_x);
                            if (width > minWidth) { elmnt.style.width = width + 'px'; elmnt.style.left = original_left + (e.pageX - original_mouse_x) + 'px'; }
                        }
                        if (resizer.classList.contains('resizer-t') || resizer.classList.contains('resizer-lt') || resizer.classList.contains('resizer-rt')) {
                            const height = original_height - (e.pageY - original_mouse_y);
                            if (height > minHeight) { elmnt.style.height = height + 'px'; elmnt.style.top = original_top + (e.pageY - original_mouse_y) + 'px'; }
                        }
                    }
                    function stopResize() {
                        window.removeEventListener('mousemove', doResize);
                        window.removeEventListener('mouseup', stopResize);
                        elmnt.style.removeProperty('transition');
                    }
                }
            });
        }
        
        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => { 
            const floatingWindow = document.createElement('div');
            floatingWindow.id = 'floating-editor-window';
            
            floatingWindow.innerHTML = `
                <div class="floating-editor-header">
                    <span>Editor Layer</span>
                    <div class="editor-header-actions">
                        <button id="undoBtn" class="btn btn-secondary" disabled>Undo</button>
                        <button id="redoBtn" class="btn btn-secondary" disabled>Redo</button>
                        <button id="addLayerBtn" class="btn btn-primary">Tambah Layer</button>
                        <button id="minimize-editor-btn" class="editor-control-btn" title="Sembunyikan Editor">
                            <svg viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 6H11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>
                <div id="layers-editor-container" class="flex flex-col gap-4"></div>
                <div class="resizer resizer-r"></div>
                <div class="resizer resizer-b"></div>
                <div class="resizer resizer-rb"></div>
                <div class="resizer resizer-t"></div>
                <div class="resizer resizer-l"></div>
                <div class="resizer resizer-lt"></div>
                <div class="resizer resizer-rt"></div>
                <div class="resizer resizer-bl"></div>
            `;
            document.body.appendChild(floatingWindow);
            layersEditorContainer = document.getElementById('layers-editor-container');

            assignGlobalDOMElements();
            addEventListeners();
            makeDraggable(floatingWindow);
            makeResizable(floatingWindow);
            initializeInstruments(); 

            document.getElementById('minimize-editor-btn').addEventListener('click', () => toggleEditorWindow('minimize'));
            document.getElementById('show-editor-button').addEventListener('click', () => toggleEditorWindow('maximize'));
            document.getElementById('minimize-instructions-btn').addEventListener('click', toggleInstructionsWindow);
            document.getElementById('maximize-instructions-btn').addEventListener('click', toggleInstructionsWindow);

            const lightThemeBtn = document.getElementById('light-theme-btn');
            const darkThemeBtn = document.getElementById('dark-theme-btn');

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark');
                    darkThemeBtn.classList.add('active');
                    lightThemeBtn.classList.remove('active');
                } else {
                    document.body.classList.remove('dark');
                    lightThemeBtn.classList.add('active');
                    darkThemeBtn.classList.remove('active');
                }
                localStorage.setItem('theme', theme);
            }

            lightThemeBtn.addEventListener('click', () => applyTheme('light'));
            darkThemeBtn.addEventListener('click', () => applyTheme('dark'));
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            startNewProject(); // Initialize with new default values
        });
    </script>
</body>
</html>
